<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å’Œ Noto Sans TC ç¢ºä¿ä¸­è‹±æ–‡å­—é«”ç¾è§€ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯, ç¬¦åˆé»‘å¹«ä¸»é¡Œ */
        }
        .text-shadow-custom {
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .gold-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            font-weight: 700;
        }
        .gold-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        .gold-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        /* æˆåŠŸç•«é¢ç‰¹æ•ˆ */
        .success-bg {
            background: radial-gradient(circle at center, #ffeb3b 0%, #ffc107 70%, #ff9800 100%);
            animation: pulse-gold 1.5s infinite alternate;
        }
        @keyframes pulse-gold {
            from { filter: brightness(1.0); }
            to { filter: brightness(1.1); }
        }
        /* æ™‚é–“å¿«åˆ°æ™‚çš„é–ƒçˆæ•ˆæœ */
        .timer-warning {
            animation: flash-red 0.5s infinite alternate;
        }
        @keyframes flash-red {
            from { background-color: #8b0000; }
            to { background-color: #dc2626; }
        }
        /* æ–°å¢ï¼šå€’æ•¸å‰©ä¸‹ 2 åˆ†é˜æ™‚çš„æ”¾å¤§æ•ˆæœ */
        .timer-large {
            font-size: 1.5rem; /* è®Šå¤§ */
            padding: 0.75rem; /* å¢åŠ å…§é‚Šè· */
            border: 3px solid #ffeb3b; /* å¢åŠ é‚Šæ¡†å¼·èª¿ */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transition: all 0.3s ease-in-out;
        }
        /* æ•˜äº‹æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
        .fade-transition {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .fade-in {
            opacity: 1;
        }
        .fade-out {
            opacity: 0;
        }
        /* è€å¤§é¸æ“‡ä»‹é¢æ¨£å¼ */
        .boss-item {
            aspect-ratio: 1 / 1;
        }
        .boss-check {
            opacity: 0;
            transition: opacity 0.2s;
        }
    </style>
    
    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyCR-oc58h8fmdqt-7VU1F9hstznu0l0vvQ",
            authDomain: "casini-game.firebaseapp.com",
            projectId: "casini-game",
            storageBucket: "casini-game.firebasestorage.app",
            messagingSenderId: "615777698848",
            appId: "1:615777698848:web:a6ec9b8eb872168d86a845"
        };
        
        // --- 2. åˆå§‹åŒ–ä¸¦å®šç¾©å…¨åŸŸè®Šæ•¸ ---
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        // è¨­å®š App ID ä½œç‚ºè³‡æ–™åº«è·¯å¾‘çš„ä¸€éƒ¨åˆ† (é€™è£¡ä½¿ç”¨ projectId)
        window.APP_ID = firebaseConfig.projectId;
        window.currentUserId = null;
        window.isAuthReady = false;

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ï¼Œå¹«åŠ©èª¿è©¦
        setLogLevel('error');
        
        // --- 3. ç›£è½èªè­‰ç‹€æ…‹ä¸¦åˆå§‹åŒ–éŠæˆ² ---
        onAuthStateChanged(window.auth, (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase: åŒ¿åç™»å…¥æˆåŠŸ. User ID:", user.uid);
            } else {
                console.log("Firebase: ç­‰å¾…åŒ¿åç™»å…¥.");
            }
            window.isAuthReady = true;
            // ç¢ºä¿éŠæˆ²åœ¨èªè­‰å°±ç·’å¾Œå•Ÿå‹•
            if (document.readyState === 'loading') {
                window.onload = initGame;
            } else {
                initGame();
            }
        });
        
        // å°‡å¿…è¦çš„ Firebase å‡½æ•¸æš´éœ²çµ¦ä¸»è…³æœ¬
        window.fs = { collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, Timestamp, signInAnonymously };

    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- èƒŒæ™¯éŸ³æ¨‚ (è«‹ç¢ºä¿æ­¤æª”æ¡ˆåç¨± Mission Impossible Theme (Full Theme).mp3 å·²åœ¨ GitHub æ ¹ç›®éŒ„ä¸”åç¨±å®Œå…¨ä¸€è‡´) -->
    <audio id="bgm" loop>
        <source src="Mission Impossible Theme (Full Theme).mp3" type="audio/mp3">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾ã€‚
    </audio>

    <!-- æˆåŠŸéŸ³æ•ˆ -->
    <audio id="success-sound">
        <source src="SUCCESS_Sound.mp4" type="audio/mp4">
    </audio>
    <!-- é²ä¾†æˆåŠŸéŸ³æ•ˆ -->
    <audio id="late-sound">
        <source src="LATE_sound.mp4" type="audio/mp4">
    </audio>

    <!-- ä¸»éŠæˆ²å®¹å™¨ -->
    <div id="game-container" class="bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500">
        
        <!-- æ¨™é¡Œ -->
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-yellow-400 text-shadow-custom">
            é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›²
        </h1>

        <!-- è¨ˆæ™‚å™¨é¡¯ç¤ºå€å¡Š -->
        <div id="timer-display" class="text-center text-xl font-mono p-2 mb-4 rounded-lg bg-red-800 text-yellow-300 shadow-inner hidden">
            <!-- å‰©é¤˜æ™‚é–“: 10:00 -->
        </div>

        <!-- å…§å®¹å€å¡Š -->
        <div id="game-content" class="text-lg space-y-4">
            <!-- éŠæˆ²å…§å®¹å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- äº’å‹•å€å¡Š -->
        <div id="game-controls" class="mt-8 flex flex-col space-y-4">
            <!-- æŒ‰éˆ•å’Œè¼¸å…¥æ¡†å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- è¨Šæ¯å€å¡Š (ç”¨æ–¼æç¤ºéŒ¯èª¤æˆ–æˆåŠŸ) -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-center font-bold hidden"></div>

    </div>

    <script type="text/javascript">
        // --- Firebase å…¨åŸŸè®Šæ•¸å®šç¾© ---
        let db = null;
        let auth = null;
        let APP_ID = null;
        let currentUserId = null;
        let isAuthReady = false;
        
        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        const GAME_STATE = {
            START: 0,       // éŠæˆ²é–‹å§‹æ•˜äº‹ç•«é¢
            VAULT_LOCATE: 1, // ç¢ºèªé‡‘åº«ä½æ•¸
            CLUE_HUNT: 2,    // å°‹æ‰¾é‡‘åº«å®ˆå‰‡
            CODE_ENTRY: 3,   // è¼¸å…¥å¯†ç¢¼
            SUCCESS: 4,      // æˆåŠŸ
            FAIL: 5          // å¤±æ•—
        };

        const CORRECT_CLUE = "é‡‘åº«å®ˆå‰‡";
        const CORRECT_CODE = "275"; 
        
        // è¨ˆæ™‚å™¨è¨­å®š (10 åˆ†é˜ = 600 ç§’)
        const INITIAL_TIME_SECONDS = 600;
        let timerInterval = null;
        let timeLeft = INITIAL_TIME_SECONDS;

        let currentState = GAME_STATE.START;
        
        // *** å…¨åŸŸè®Šæ•¸ï¼šç©å®¶åç¨±ã€è€å¤§é¸æ“‡ã€æ™‚é–“è¨˜éŒ„ ***
        let playerName = "";
        let selectedBossId = null; 
        let missionStartTime = 0; // ä»»å‹™é–‹å§‹æ™‚é–“ (Date.now())
        let completionTime = 0;   // æœ€çµ‚é€šé—œæ™‚é–“ (ç§’)

        // å¯†ç¢¼æç¤ºç›¸é—œ
        let hintsRevealed = 0; 
        
        // *** DOM å…ƒç´ å®£å‘Š (ä¿®å¾©é»ï¼šç¢ºä¿å®ƒå€‘æœ‰é è¨­å€¼ï¼Œä¸”åœ¨ initGame ä¸­ç²å–) ***
        let container, contentDiv, controlsDiv, messageArea, timerDisplay, bgm, successSound, lateSound;

        // *** å°è©±å…§å®¹ (ç”±è€å¤§æ•˜äº‹) ***
        let currentDialogueStep = 0; 
        const DIALOGUE_STEPS = (name) => [
            { speaker: 'BOSS', text: `<span class="text-red-400">${name}</span>ä½ ä¾†å•¦â‹¯â‹¯`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'PLAYER', text: `è€å¤§ï¼æœ‰ä½•å©å’ï¼Ÿ`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'BOSS', text: `ä½ è¢«é‚€è«‹åˆ°é€™å ´ç”±é»‘å¹«èˆ‰è¾¦çš„è³­å ´å®´æœƒï¼Œè¡¨é¢ä¸Šæ˜¯ä¾†ä¸€æ“²åƒé‡‘çš„å®¢äººï¼Œä½†ä½ çœŸæ­£çš„ç›®æ¨™æ˜¯è³­å ´å¾Œé¢çš„é‚£åº§<span class="text-yellow-500 font-bold">é‡‘åº«</span>ï¼`, buttonText: "ç¹¼çºŒ" },
            { 
                speaker: 'BOSS', 
                text: `ä»Šå¤©å¾ˆå¤šå…¶ä»–é»‘å¹«æˆå“¡ä¹Ÿæ˜¯æ‰“è‘—è·Ÿä½ ä¸€æ¨£çš„ä¸»æ„ï¼Œä½ å¿…é ˆçˆ­åˆ†å¥ªç§’ï¼Œç›¡å¿«æŠŠé‡‘åº«æ‰“é–‹ï¼Œ<span class="text-yellow-400 font-bold">ä¸ç„¶è£¡é¢çš„é‡‘å¹£æœƒè¢«å…¶ä»–äººæ·è¶³å…ˆç™»ï¼</span>`, 
                buttonText: "ç¹¼çºŒ" 
            },
            {
                speaker: 'BOSS',
                text: `ç¾åœ¨ï¼Œä½ è¶ä¿é¢åœ¨æ‰“çŒç¡ï¼Œå·²ç¶“å·å·æ½›å…¥åˆ°äº†è³­å ´çš„é‡‘åº«ä½ç½®ã€‚<br>å™“ï¼å°å¿ƒä¸è¦è¢«ç™¼ç¾ï¼<br><span class="text-yellow-400 font-bold">ååˆ†é˜å…§</span>ä½ å¿…é ˆè§£å‡ºé€™å€‹è¬é¡Œï¼Œä¸ç„¶æ›ç­çš„äººå°±è¦ä¾†äº†ï¼Œä½ æœƒè¢«æŠ“å€‹æ­£è‘—ï¼<br>ä»”ç´°æŸ¥çœ‹é‡‘åº«åœ¨å“ªè£¡ï¼Ÿé‚„æœ‰å¯†ç¢¼ï¼Œä½ éœ€è¦çŸ¥é“å¯†ç¢¼æ˜¯å¹¾ä½æ•¸ã€‚`,
                buttonText: "å·å·æ½›å…¥é‡‘åº«",
                action: 'START_MISSION'
            }
        ];

        // --- Firebase å‡½å¼åº«åƒè€ƒ ---
        let fs = null;

        // --- éŠæˆ²åˆå§‹åŒ–å…¥å£ ---
        function initGame() {
            // *** ä¿®æ­£é»ï¼šåœ¨å‡½æ•¸å…§éƒ¨ç²å– DOM å…ƒç´ ï¼Œç¢ºä¿å®ƒå€‘å·²å®šç¾© ***
            container = document.getElementById('game-container');
            contentDiv = document.getElementById('game-content');
            controlsDiv = document.getElementById('game-controls');
            messageArea = document.getElementById('message-area');
            timerDisplay = document.getElementById('timer-display');
            bgm = document.getElementById('bgm');
            successSound = document.getElementById('success-sound');
            lateSound = document.getElementById('late-sound');
            
            // å¾ Window ç¯„åœç²å– Firebase å¯¦ä¾‹
            db = window.db;
            auth = window.auth;
            APP_ID = window.APP_ID;
            fs = window.fs;
            currentUserId = window.currentUserId;
            isAuthReady = window.isAuthReady;

            // ç¢ºä¿ Firebase è®Šæ•¸å·²æˆåŠŸåˆå§‹åŒ–
            if (!db || !auth || !APP_ID || !fs) {
                console.error("Firebase SDK è¼‰å…¥å¤±æ•—æˆ–åˆå§‹åŒ–æœªå®Œæˆ.");
                // å¦‚æœ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œä»å…è¨±éŠæˆ²å•Ÿå‹•ï¼Œä½†ä¸åŸ·è¡Œç´€éŒ„åŠŸèƒ½
                goToInitialImageScreen();
                return;
            }
            
            goToInitialImageScreen();
        }
        
        // --- éŸ³æ¨‚/è¨ˆæ™‚å™¨/è¼”åŠ©å‡½æ•¸ (ç•¥ï¼Œå…§å®¹èˆ‡ä¹‹å‰ç›¸åŒ) ---
        function startBGM() {
            if (bgm && bgm.paused) {
                bgm.volume = 0.5;
                bgm.play().catch(error => {
                    console.log("BGM è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ã€‚", error);
                });
            }
        }
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }
        function updateTimer() {
            if (timeLeft < 0) {
                timeLeft = 0;
            }
            timerDisplay.textContent = `å‰©é¤˜æ™‚é–“: ${formatTime(timeLeft)}`;

            if (timeLeft <= 120 && timeLeft > 0) {
                timerDisplay.classList.add('timer-large');
            } else {
                timerDisplay.classList.remove('timer-large');
            }

            if (timeLeft <= 60 && timeLeft > 0) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.remove('timer-warning');
            }

            if (timeLeft <= 0) {
                stopTimer();
                timerDisplay.textContent = "æ™‚é–“åˆ°ï¼æ›ç­ä¿é¢å·²åˆ°ï¼Œè«‹å¿«é€Ÿå®Œæˆå¯†ç¢¼è¼¸å…¥ã€‚";
                return;
            }
            timeLeft--;
        }
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = INITIAL_TIME_SECONDS;
            timerDisplay.classList.remove('hidden');
            updateTimer(); 
            timerInterval = setInterval(updateTimer, 1000);
        }
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        function showMessage(text, isError = false) {
            messageArea.textContent = text;
            messageArea.className = `mt-4 p-3 rounded-lg text-center font-bold ${isError ? 'bg-red-700' : 'bg-green-700'}`;
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 3000);
        }
        function clearScreen() {
            contentDiv.innerHTML = '';
            controlsDiv.innerHTML = '';
        }
        function renderButton(text, onClick, isFinalStep = false, id = null) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full';
            button.onclick = onClick;
            if (id) button.id = id;
            controlsDiv.appendChild(button);
        }
        function renderInput(placeholder, buttonText, onSubmit, inputId, maxLength) {
            const constContainer = document.createElement('div');
            constContainer.className = 'flex flex-col space-y-3';
            
            const input = document.createElement('input');
            input.id = inputId;
            input.type = 'text';
            input.maxLength = maxLength || 50;
            input.placeholder = placeholder;
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400';
            
            const button = document.createElement('button');
            button.textContent = buttonText;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg';
            button.onclick = () => onSubmit(document.getElementById(inputId).value);

            input.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    onSubmit(document.getElementById(inputId).value);
                }
            });

            constContainer.appendChild(input);
            constContainer.appendChild(button);
            controlsDiv.appendChild(constContainer);
        }
        function revealHint() {
            if (hintsRevealed >= HINTS.length) {
                showMessage("å·²ç¶“æ²’æœ‰æ›´å¤šæç¤ºäº†ï¼", true);
                return;
            }
            const timeDeduction = 60;
            if (timeLeft - timeDeduction <= 0) {
                timeLeft = 0; 
                showMessage("æ™‚é–“ç”¨ç›¡ï¼ä½ ç„¡æ³•å†ç²å–æç¤ºäº†ã€‚", true);
                updateTimer();
            } else {
                timeLeft -= timeDeduction;
                showMessage(`æ‰£é™¤ ${timeDeduction} ç§’ã€‚è«‹åƒè€ƒæ–°æç¤ºã€‚`, false);
                updateTimer();
            }
            
            const hintText = HINTS[hintsRevealed];
            const hintDiv = document.getElementById('hint-messages');
            
            const p = document.createElement('p');
            p.className = "mt-2 p-3 bg-gray-700 rounded-lg border border-red-500 transition-all duration-300 transform scale-100 hover:scale-[1.02]";
            p.innerHTML = `<span class="text-red-400 font-bold">[æç¤º #${hintsRevealed + 1} (-60ç§’)]</span>: ${hintText}`;
            hintDiv.appendChild(p);
            hintsRevealed++;
            
            const hintButton = document.getElementById('reveal-hint-button');
            if (hintsRevealed >= HINTS.length) {
                hintButton.textContent = "å·²ç„¡æ›´å¤šæç¤º";
                hintButton.disabled = true;
                hintButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                hintButton.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else {
                hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šç´€éŒ„é€šé—œæ™‚é–“èˆ‡æ’åè¨ˆç®— ---

        /** å–å¾— Firestore æ’å Collection çš„è·¯å¾‘ */
        function getPublicRanksCollectionRef() {
            if (!db || !APP_ID) {
                console.error("Firestore DB æˆ– APP_ID å°šæœªåˆå§‹åŒ–.");
                return null;
            }
            // ä½¿ç”¨å…¬å…±è·¯å¾‘ /artifacts/{appId}/public/data/{collectionName}
            return fs.collection(db, `artifacts/${APP_ID}/public/data/puzzle_ranks`);
        }

        /** å¯«å…¥é€šé—œç´€éŒ„ä¸¦ç²å–æ’å */
        async function recordCompletionAndShowRank(isLate) {
            if (!db || !currentUserId) {
                console.error("ç„¡æ³•å¯«å…¥ç´€éŒ„ï¼šFirebase æˆ– User ID å°šæœªæº–å‚™å¥½ã€‚");
                return { rank: 'N/A', totalRecords: 'N/A' };
            }

            const ranksRef = getPublicRanksCollectionRef();
            if (!ranksRef) return { rank: 'N/A', totalRecords: 'N/A' };

            const newRecord = {
                name: playerName,
                userId: currentUserId,
                completionTime: completionTime,
                timestamp: fs.serverTimestamp(), // ä½¿ç”¨ä¼ºæœå™¨æ™‚é–“ç¢ºä¿æ’åºç²¾ç¢º
                isLate: isLate,
                bossId: selectedBossId
            };
            
            // 1. å¯«å…¥æ–°çš„é€šé—œç´€éŒ„
            let docRef;
            try {
                docRef = await fs.addDoc(ranksRef, newRecord);
                console.log("Record added with ID:", docRef.id);
            } catch (e) {
                console.error("Error adding document:", e);
                return { rank: 'Error', totalRecords: 'Error' };
            }

            // 2. ç²å–ç•¶å¤©çš„æ‰€æœ‰ç´€éŒ„ä¸¦æ’åº
            
            // ç²å–ç•¶å¤©é›¶é»çš„æ™‚é–“æˆ³ (ç”¨æ–¼æ¯æ—¥é‡è¨­ç¯©é¸)
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0); 
            const todayTimestamp = fs.Timestamp.fromDate(todayStart);

            // æŸ¥è©¢ç•¶å¤©æ‰€æœ‰ç´€éŒ„ï¼ŒæŒ‰æ™‚é–“å‡åºæ’åˆ—
            const q = fs.query(
                ranksRef,
                fs.where("timestamp", ">=", todayTimestamp), 
                fs.orderBy("timestamp", "asc")
            );

            try {
                const querySnapshot = await fs.getDocs(q);
                let rank = 'N/A';
                const totalRecords = querySnapshot.docs.length;

                // 3. è¨ˆç®—æ’å
                querySnapshot.docs.forEach((doc, index) => {
                    // æª¢æŸ¥ userId æ˜¯å¦åŒ¹é…ï¼Œæˆ–è€…æª¢æŸ¥æ–‡æª”IDæ˜¯å¦åŒ¹é…
                    if (doc.id === docRef.id) {
                        rank = index + 1;
                    }
                });
                
                return { rank: rank, totalRecords: totalRecords };

            } catch (e) {
                console.error("Error fetching documents:", e);
                return { rank: 'Error', totalRecords: 'Error' };
            }
        }


        // --- æµç¨‹æ§åˆ¶å‡½æ•¸ ---

        /** é€æ­¥é¡¯ç¤ºå°è©±å…§å®¹ */
        function displayNextDialogue() {
            const dialogueData = DIALOGUE_STEPS(playerName);
            if (currentDialogueStep >= dialogueData.length) {
                goToVaultLocate();
                return;
            }

            const step = dialogueData[currentDialogueStep];

            // 1. æ·¡å‡ºèˆŠå…§å®¹
            const currentContent = document.getElementById('dialogue-wrapper');
            if (currentContent) {
                currentContent.classList.remove('fade-in');
                currentContent.classList.add('fade-out');
            }
            
            // 2. å»¶é²å¾Œæ›´æ–°å…§å®¹ä¸¦æ·¡å…¥
            setTimeout(() => {
                controlsDiv.innerHTML = '';
                
                let wrapper = document.getElementById('dialogue-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.id = 'dialogue-wrapper';
                    wrapper.className = 'fade-transition space-y-4';
                    contentDiv.appendChild(wrapper);
                }
                
                // æ±ºå®šèªªè©±è€…æ¨£å¼
                const speakerClass = step.speaker === 'BOSS' ? 'text-yellow-400 font-bold' : 'text-green-400 font-bold';
                const speakerName = step.speaker === 'PLAYER' ? playerName : 'è€å¤§';

                wrapper.innerHTML = `
                    <div class="p-4 bg-gray-700 rounded-lg shadow-inner">
                        <p class="${speakerClass} mb-2">${speakerName}:</p>
                        <p class="text-gray-200">${step.text}</p>
                    </div>
                `;
                wrapper.classList.remove('fade-out');
                wrapper.classList.add('fade-in');
                
                // 3. æ¸²æŸ“æŒ‰éˆ•
                const buttonAction = () => {
                    if (step.action === 'START_MISSION') {
                        // è¨˜éŒ„ä»»å‹™é–‹å§‹çš„ç²¾ç¢ºæ™‚é–“
                        missionStartTime = Date.now(); 
                        startTimer(); 
                        goToVaultLocate(); 
                    } else {
                        currentDialogueStep++;
                        displayNextDialogue();
                    }
                };

                renderButton(step.buttonText, buttonAction);
                window.scrollTo(0, 0); 
            }, 1000); 
        }

        
        /** å‰ç½®éšæ®µ: åˆå§‹åœ–ç‰‡ç•«é¢ */
        function goToInitialImageScreen() {
            clearScreen();
            stopTimer(); 
            timerDisplay.classList.add('hidden');

            document.body.className = 'min-h-screen flex items-center justify-center p-4 bg-gray-900';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <div class="text-center space-y-6">
                    <!-- ç§»é™¤å†—é¤˜çš„ H2 æ¨™é¡Œ -->
                    <p class="text-lg text-gray-300">ä¸€å ´ç§˜å¯†è¡Œå‹•å³å°‡å±•é–‹...</p>
                    
                    <!-- åˆå§‹åœ–ç‰‡ï¼šcover.jpg -->
                    <img src="cover.jpg" 
                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/29294F/FFF?text=èµ·å§‹ç•«é¢åœ–ç‰‡';"
                         alt="èµ·å§‹ç•«é¢åœ–ç‰‡" 
                         class="mx-auto w-full max-w-sm rounded-lg shadow-xl border-2 border-yellow-500 object-cover"
                    >
                </div>
            `;
            
            // --- å‹¾é¸æ¡†å€åŸŸ ---
            const checkboxArea = document.createElement('div');
            checkboxArea.className = 'mt-6 space-y-3 text-left text-gray-200';
            checkboxArea.innerHTML = `
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-network" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹ç¢ºä¿ç¶²è·¯ç©©å®š</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-volume" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹æ‰“é–‹éŠæˆ²éŸ³é‡</span>
                </label>
            `;
            controlsDiv.appendChild(checkboxArea);

            // --- æŒ‰éˆ• ---
            const initialButton = document.createElement('button');
            initialButton.id = 'initial-start-button';
            initialButton.textContent = "é€²å…¥ç§˜å¯†ä»»å‹™";
            initialButton.disabled = true; // é è¨­ç¦ç”¨
            initialButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            controlsDiv.appendChild(initialButton);

            // --- æª¢æŸ¥å‡½æ•¸ ---
            function checkPreconditions() {
                const networkChecked = document.getElementById('check-network').checked;
                const volumeChecked = document.getElementById('check-volume').checked;

                const isReady = networkChecked && volumeChecked;
                initialButton.disabled = !isReady;

                if (isReady) {
                    initialButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    messageArea.classList.add('hidden');
                } else {
                    initialButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                }
            }

            // --- ç›£è½å‹¾é¸æ¡† ---
            document.getElementById('check-network').addEventListener('change', checkPreconditions);
            document.getElementById('check-volume').addEventListener('change', checkPreconditions);

            // --- è™•ç†æŒ‰éˆ•é»æ“Š (å³ä½¿è¢«ç¦ç”¨ä¹Ÿéœ€è¦æª¢æŸ¥) ---
            initialButton.onclick = () => {
                if (!initialButton.disabled) {
                    // åŸ·è¡Œ Firebase åŒ¿åç™»å…¥
                    fs.signInAnonymously(auth).then(() => {
                        console.log("Anonymous sign-in triggered.");
                    }).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        showMessage("é€£ç·šè‡³ä¼ºæœå™¨å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", true);
                    });
                    goToBossSelection();
                } else {
                    showMessage("è«‹ç¢ºä¿ä¸Šæ–¹å…©é …çš†å·²ç¢ºèª", true);
                }
            };
        }

        /** æ–°å¢ï¼šè€å¤§é¸æ“‡é é¢ */
        function goToBossSelection() {
            // ... (è€å¤§é¸æ“‡é é¢é‚è¼¯ä¸è®Š)
            clearScreen();
            window.scrollTo(0, 0);
            selectedBossId = null; // é‡ç½®é¸æ“‡

            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-4">ä½ çš„è€å¤§æ˜¯ï¼Ÿ</h2>
                <p class="text-sm text-gray-400 text-center mb-6">*äººç‰©ä¸å½±éŸ¿æ•…äº‹é€²è¡Œ</p>
                
                <div id="boss-grid" class="grid grid-cols-3 gap-2">
                    <!-- è€å¤§åœ–ç‰‡å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
                </div>
            `;
            
            const confirmButton = document.createElement('button');
            confirmButton.id = 'confirm-boss-button';
            confirmButton.textContent = "æˆ‘çš„è€å¤§æ˜¯ä»–/å¥¹"; 
            confirmButton.disabled = true; // é è¨­ç¦ç”¨
            confirmButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            
            // åªæœ‰ç•¶ Auth Ready ä¸”é¸å®Œè€å¤§å¾Œæ‰èƒ½é€²å…¥ä¸‹ä¸€æ­¥
            confirmButton.onclick = () => {
                 if (isAuthReady && currentUserId) {
                    goToNameInput();
                 } else {
                    showMessage("ä¼ºæœå™¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true);
                 }
            };
            controlsDiv.appendChild(confirmButton);


            // --- åœ–ç‰‡æ¸²æŸ“å’Œé¸æ“‡é‚è¼¯ ---
            const bosses = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const gridDiv = document.getElementById('boss-grid');

            bosses.forEach(id => {
                const item = document.createElement('div');
                item.className = 'boss-item relative cursor-pointer border-4 border-transparent rounded-lg overflow-hidden transition-all duration-200 hover:border-yellow-500';
                item.setAttribute('data-boss-id', id);
                item.onclick = () => selectBoss(id);

                // è«‹ç¢ºä¿æ‚¨å·²ä¸Šå‚³ boss_1.png åˆ° boss_9.png
                item.innerHTML = `
                    <img src="boss_${id}.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x100/3A3A3A/FFF?text=Boss%20${id}';"
                         alt="è€å¤§ ${id}" 
                         class="w-full h-full object-cover rounded-md"
                    >
                    <div id="check-${id}" class="boss-check absolute inset-0 bg-black/50 flex items-center justify-center text-4xl text-yellow-400">
                        âœ“
                    </div>
                `;
                gridDiv.appendChild(item);
            });
            
            function selectBoss(id) {
                selectedBossId = id;
                document.querySelectorAll('.boss-item').forEach(item => {
                    const itemId = parseInt(item.getAttribute('data-boss-id'));
                    const check = item.querySelector('.boss-check');
                    if (itemId === id) {
                        item.classList.add('border-yellow-400');
                        check.classList.add('opacity-100');
                    } else {
                        item.classList.remove('border-yellow-400');
                        check.classList.remove('opacity-100');
                    }
                });

                // å•Ÿç”¨æŒ‰éˆ• (å¦‚æœ Auth å·²æº–å‚™å¥½)
                if (isAuthReady) {
                    confirmButton.disabled = false;
                    confirmButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    confirmButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                }
            }
        }

        /** æ–°å¢ï¼šåç¨±è¼¸å…¥é é¢ */
        function goToNameInput() {
            clearScreen();
            window.scrollTo(0, 0);
            
            // è¨­ç½®å®¹å™¨æ¨£å¼
            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-6">å‘Šè¨´è€å¤§ä½ çš„ä»£è™Ÿ</h2>
                <p class="text-md text-gray-400 text-center">é€™æ˜¯ä½ ç¨ä¸€ç„¡äºŒçš„èº«ä»½ï¼Œå°‡ç”¨æ–¼ç´€éŒ„ä½ çš„é€šé—œé †åºã€‚</p>
            `;

            // å®šç¾©æäº¤åç¨±çš„å‡½æ•¸
            const submitName = (name) => {
                const trimmedName = name.trim();
                if (trimmedName.length >= 2 && trimmedName.length <= 10) {
                    playerName = trimmedName;
                    showMessage(`ä»£è™Ÿï¼š${playerName}ï¼Œç¢ºèªï¼`, false);
                    setTimeout(goToMissionDialogue, 1500); // é€²å…¥æ–°çš„å°è©±å ´æ™¯
                } else {
                    showMessage("ä»£è™Ÿé•·åº¦éœ€åœ¨ 2 åˆ° 10 å€‹å­—å…ƒä¹‹é–“ã€‚", true);
                }
            };

            // æ¸²æŸ“è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
            renderInput("è«‹è¼¸å…¥ä½ çš„é»‘å¹«åŒ–åï¼ˆ2-10å€‹å­—ï¼‰", "ç¢ºèªä»£è™Ÿ", submitName, 'codename-input', 10); // <-- å·²ä¿®æ”¹è¼¸å…¥æ¡†æç¤ºæ–‡å­—
            document.getElementById('codename-input').focus();
        }

        /** æ–°å¢ï¼šå°è©±å ´æ™¯å…¥å£ */
        function goToMissionDialogue() {
            currentState = GAME_STATE.START;
            clearScreen();
            stopTimer();
            hintsRevealed = 0;
            timerDisplay.classList.add('hidden'); 
            
            // BGM åœ¨é€™è£¡å•Ÿå‹•
            startBGM(); 
            
            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            // é¡¯ç¤ºè€å¤§åœ–ç‰‡
            contentDiv.innerHTML = `
                <div class="text-center mb-6">
                    <img src="boss_${selectedBossId}.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/3A3A3A/FFF?text=BOSS';"
                         alt="é¸å®šçš„è€å¤§" 
                         class="mx-auto w-32 h-32 object-cover rounded-full shadow-lg border-4 border-red-500"
                    >
                </div>
                <div id="dialogue-content-area" class="space-y-4">
                    <!-- å°è©±å…§å®¹å°‡åœ¨æ­¤è™•é¡¯ç¤º -->
                </div>
            `;
            
            // æº–å‚™å°è©±å…§å®¹çš„åŒ…è£¹å™¨
            const dialogueArea = document.getElementById('dialogue-content-area');
            const wrapper = document.createElement('div');
            wrapper.id = 'dialogue-wrapper';
            wrapper.className = 'fade-transition space-y-4';
            dialogueArea.appendChild(wrapper);

            currentDialogueStep = 0; // é‡ç½®å°è©±æ­¥é©Ÿ
            displayNextDialogue(); // é–‹å§‹é¡¯ç¤ºç¬¬ä¸€æ®µå°è©±
        }

        /** éšæ®µ 1: ç¢ºèªå¯†ç¢¼ä½æ•¸ */
        function goToVaultLocate() {
            currentState = GAME_STATE.VAULT_LOCATE;
            clearScreen();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢

            contentDiv.innerHTML = `
                <p>ä½ ç¾åœ¨å·²ç¶“æˆåŠŸæ½›å…¥è³­å ´æ”¾<span class="text-yellow-500 font-bold">é‡‘åº«</span>çš„åœ°æ–¹ï¼è¶•å¿«æ‰¾æ‰¾é‡‘åº«åœ¨å“ªè£¡ï¼Ÿ</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸€æ­¥ã€‘</strong></p>
                <p>ä»”ç´°è§€å¯Ÿç¾å¯¦ä¸–ç•Œä¸­çš„é‡‘åº«å¯¶ç®±ï¼Œ<strong>å¯†ç¢¼é–æ˜¯å¹¾ä½æ•¸ï¼Ÿ</strong></p>
            `;

            renderInput("è«‹è¼¸å…¥å¯†ç¢¼é–çš„ä½æ•¸ (æ•¸å­—)", "ç¢ºèªä½æ•¸", checkVaultDigits, 'digit-input', 1);
            document.getElementById('digit-input').type = 'number';
        }

        /** æª¢æŸ¥å¯†ç¢¼ä½æ•¸æ˜¯å¦æ­£ç¢º (3) */
        function checkVaultDigits(input) {
            const digitInput = parseInt(input.trim());
            
            if (digitInput === 3) {
                showMessage("æ•¸å­—æ­£ç¢ºï¼ä½ ç™¼ç¾äº†é‡‘åº«å¯†ç¢¼æ˜¯ä¸‰ä½æ•¸å¯†ç¢¼é–ã€‚", false);
                setTimeout(() => {
                    window.scrollTo(0, 0); 
                    goToClueHunt();
                }, 2500);
                return;
            }

            // æä¾›å¼•å°æç¤º
            let hintMessage = "é€™å€‹ä½æ•¸ä¸æ­£ç¢ºã€‚";
            if (isNaN(digitInput) || digitInput === 0) {
                hintMessage = "è«‹è¼¸å…¥ä¸€å€‹æ•¸å­—ã€‚ä½ éœ€è¦æ‰¾åˆ°é‡‘åº«å¯¶ç®±ï¼Œä¸Šé¢æ‡‰è©²æœ‰å¯†ç¢¼é–ã€‚";
            } else if (digitInput > 4) {
                hintMessage = `é€™å€‹æ•¸å­—å¤ªå¤§äº†ã€‚å†ä»”ç´°çœ‹çœ‹ï¼Œé€™å€‹é–çš„çµæ§‹ä¼¼ä¹å¾ˆç°¡å–®ï¼Œåªé å¹¾å€‹è½‰ç›¤é‹ä½œã€‚`;
            } else if (digitInput === 2) {
                 hintMessage = `åªæœ‰å…©ä½æ•¸å—ï¼Ÿè«‹å†é è¿‘ä¸€é»æ•¸æ•¸çœ‹ï¼Œå¯†ç¢¼è½‰ç›¤æ˜¯ä¸æ˜¯æœ‰ä¸‰å€‹ï¼Ÿ`;
            } else if (digitInput === 4) {
                 hintMessage = `ä¸å°ï¼Œå®ƒä¸æ˜¯å››ä½æ•¸çš„ã€‚ä»”ç´°æ•¸æ•¸ï¼Œå¯†ç¢¼é–åªæœ‰ä¸‰å€‹å¯ä»¥è½‰å‹•çš„ç›¤ã€‚`;
            } else {
                hintMessage = "é€™å€‹ä½æ•¸ä¸æ­£ç¢ºã€‚è«‹å†æ¬¡ç¢ºèªé‡‘åº«å¯¶ç®±ä¸Šå¯†ç¢¼é–çš„æ•¸å­—è½‰ç›¤æ•¸é‡ã€‚";
            }
            
            showMessage(hintMessage, true);
        }

        /** éšæ®µ 2: å°‹æ‰¾ç·šç´¢ (æ‰¾é‡‘åº«å®ˆå‰‡) */
        function goToClueHunt() {
            currentState = GAME_STATE.CLUE_HUNT;
            clearScreen();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢
            // Timer is already running

            contentDiv.innerHTML = `
                <p>ä½ ç¢ºèªäº†ï¼Œé‡‘åº«é–éœ€è¦<strong>ä¸‰ä½æ•¸å¯†ç¢¼</strong>æ‰èƒ½æ‰“é–‹ã€‚åŒæ™‚ï¼Œä½ ç™¼ç¾<strong>é‡‘åº«ä¸Šæœ‰ä¸€å€‹æç¤º</strong>å¯«è‘—ä»€éº¼â‹¯â‹¯ã€‚</p>
                <p>é‡‘åº«å¯†ç¢¼æ¯å¤©éƒ½æœƒæ›ï¼Œä½†ä½ äº‹å‰å·²ç¶“èª¿æŸ¥éï¼Œè³­å ´ä¸»äººè¨˜æ€§å¾ˆå·®ï¼Œ<strong>ç›¸é—œçš„æç¤ºä¸€å®šå°±åœ¨é‡‘åº«é™„è¿‘</strong>ã€‚</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬äºŒæ­¥ã€‘</strong></p>
                <!-- --- ä¿®æ”¹é» 3: æç¤ºæ–‡å­— --- -->
                <p>ç’°é¡§å››å‘¨ï¼Œå°‹æ‰¾å‘¨é‚Šç‰©å“ï¼Œä»€éº¼æ±è¥¿çœ‹èµ·ä¾†åƒæ˜¯åœ¨æä¾›å¯†ç¢¼çš„ç·šç´¢ï¼Ÿ</p>
                <!-- --- ä¿®æ”¹é» 3 çµæŸ --- -->
            `;

            renderInput("è«‹è¼¸å…¥ä½ ç™¼ç¾çš„ç·šç´¢åç¨± (ä¾‹å¦‚ï¼šç´™æ¢ã€ä¾¿ç±¤)", "ç¢ºèªç·šç´¢", checkClue, 'clue-input');
        }

        /** æª¢æŸ¥ç·šç´¢æ˜¯å¦æ­£ç¢º */
        function checkClue(input) {
            const normalizedInput = input.trim().replace(/\s/g, '').toLowerCase();
            
            if (normalizedInput === CORRECT_CLUE.toLowerCase()) {
                showMessage("ç·šç´¢ç¢ºèªï¼é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„ï¼", false);
                setTimeout(() => {
                    window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢
                    goToCodeEntry();
                }, 1500);
            } else {
                let hintMessage = "é€™å€‹ä¸æ˜¯æˆ‘å€‘è¦æ‰¾çš„ã€‚å†é è¿‘é‡‘åº«ä¸€é»ï¼Œé™„è¿‘æœ‰æ²’æœ‰æ¯”è¼ƒç‰¹åˆ¥çš„æ±è¥¿ï¼Ÿ";
                
                if (input.includes("è¦å‰‡") || input.includes("å®ˆå‰‡")) {
                    hintMessage = "å¾ˆæ¥è¿‘äº†ï¼ä¸æ˜¯ä¸€èˆ¬çš„è¦å‰‡ï¼Œæ˜¯è·Ÿã€é‡‘åº«ã€æœ‰é—œçš„è¦å®šï¼Œè©¦è©¦çœ‹å®Œæ•´çš„åç¨±ï¼";
                }
                
                showMessage(hintMessage, true);
            }
        }

        /** éšæ®µ 3: è¼¸å…¥å¯†ç¢¼ */
        function goToCodeEntry() {
            currentState = GAME_STATE.CODE_ENTRY;
            clearScreen();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢

            contentDiv.innerHTML = `
                <p>å¾ˆå¥½ï¼Œä½ å·²ç¶“æŒæ¡äº†é—œéµç·šç´¢ï¼š<strong>ã€é‡‘åº«å®ˆå‰‡ã€‘</strong>ã€‚</p>
                <p>çµåˆä½ å‰›æ‰åœ¨é‡‘åº«é–ä¸Šç™¼ç¾çš„æç¤ºï¼Œç¾åœ¨æ˜¯æ™‚å€™ç ´è§£ä¸‰ä½æ•¸å¯†ç¢¼äº†ï¼</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸‰æ­¥ã€‘</strong></p>
                <p>æ ¹æ“šå®ˆå‰‡å…§å®¹å’Œæç¤ºï¼Œæ¨ç®—å‡ºä¸‰ä½å¯†ç¢¼ã€‚é‡‘åº«è£¡çš„é‡‘å¹£ç­‰ä½ ï¼</p>
            `;

            // --- æç¤ºç³»çµ±å€å¡Š ---
            const hintSection = document.createElement('div');
            hintSection.className = 'mt-6 p-4 bg-gray-700 rounded-lg shadow-inner';
            hintSection.innerHTML = `
                <h3 class="text-xl font-bold text-red-400 mb-2 flex items-center">
                    <span class="text-3xl mr-2">ğŸ’¡</span>
                    <span>3å€‹æç¤º</span>
                </h3>
                <p class="text-sm text-red-300 mb-3">æ™‚é–“æ­¸é›¶ä»å¯æ‰“é–‹é‡‘åº«ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿâ‹¯â‹¯</p>
                <div id="hint-messages" class="space-y-2">
                    <!-- æç¤ºè¨Šæ¯å°‡åœ¨æ­¤è™•å‹•æ…‹é¡¯ç¤º -->
                </div>
            `;
            
            const hintButton = document.createElement('button');
            hintButton.id = 'reveal-hint-button';
            hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            hintButton.className = 'gold-button bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg w-full mt-4';
            hintButton.onclick = revealHint;
            
            hintSection.appendChild(hintButton);
            controlsDiv.appendChild(hintSection);
            
            // --- å¯†ç¢¼è¼¸å…¥å€å¡Š ---
            const inputContainer = document.createElement('div');
            inputContainer.className = 'mt-6 pt-6 border-t border-gray-600';

            const input = document.createElement('input');
            input.id = 'code-input';
            input.type = 'number';
            input.maxLength = 3;
            input.placeholder = "æ¯è¼¸éŒ¯ä¸€æ¬¡æ‰£é™¤30ç§’";
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400 w-full';
            
            const button = document.createElement('button');
            button.textContent = "è§£é–é‡‘åº«ï¼";
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full mt-3';
            button.onclick = () => checkCode(document.getElementById('code-input').value);

            input.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    checkCode(document.getElementById('code-input').value);
                }
            });

            inputContainer.appendChild(input);
            inputContainer.appendChild(button);
            controlsDiv.appendChild(inputContainer);
        }

        /** æª¢æŸ¥å¯†ç¢¼æ˜¯å¦æ­£ç¢º */
        function checkCode(input) {
            const normalizedInput = input.trim();
            
            if (normalizedInput === CORRECT_CODE) {
                showMessage("å¯†ç¢¼æ­£ç¢ºï¼é‡‘åº«é–æ­£åœ¨è§£é–‹...", false);
                
                // è¨ˆç®—é€šé—œæ™‚é–“ (ç§’)
                completionTime = Math.floor((Date.now() - missionStartTime) / 1000); 

                if (timeLeft <= 0) {
                    setTimeout(() => goToLateSuccess(true), 2000); // å‚³é isLate=true
                } else {
                    setTimeout(() => goToSuccess(false), 2000); // å‚³é isLate=false
                }
            } else {
                // *** å¯†ç¢¼éŒ¯èª¤æ™‚æ‰£é™¤ 30 ç§’ ***
                const timeDeduction = 30;
                
                if (timeLeft - timeDeduction <= 0) {
                    timeLeft = 0; 
                    stopTimer(); // ç¢ºä¿è¨ˆæ™‚å™¨å·²åœæ­¢
                    showMessage(`å¯†ç¢¼éŒ¯èª¤ï¼é–å®šæ©Ÿåˆ¶æ­£åœ¨å•Ÿå‹•... æ™‚é–“å·²ç”¨ç›¡ï¼`, true);
                    updateTimer();
                } else {
                    timeLeft -= timeDeduction;
                    showMessage(`å¯†ç¢¼éŒ¯èª¤ï¼é–å®šæ©Ÿåˆ¶æ­£åœ¨å•Ÿå‹•... å°å¿ƒè¬¹æ…ï¼ä¸ç„¶è­¦å ±å°±è¦éŸ¿äº†ï¼`, true);
                    updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
                }
            }
        }

        /**
         * éšæ®µ 4a: æ­£å¸¸æˆåŠŸç•«é¢ (æ™‚é–“å…§å®Œæˆ)
         * æ–°å¢ï¼šFirebase ç´€éŒ„èˆ‡æ’åé¡¯ç¤º
         */
        async function goToSuccess(isLate) {
            currentState = GAME_STATE.SUCCESS;
            
            // åœæ­¢ BGM ä¸¦æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            bgm.pause();
            successSound.play().catch(error => console.log("Success sound playback failed:", error));

            stopTimer();
            timerDisplay.classList.add('hidden');
            clearScreen();
            window.scrollTo(0, 0);

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            contentDiv.innerHTML = `
                <div class="text-center py-10">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-4">æ­£åœ¨è¨ˆç®—æ‚¨çš„æ’å...</h2>
                    <p class="text-lg text-gray-400">æ­£åœ¨ç­‰å¾…ä¼ºæœå™¨ç¢ºèªæ‚¨çš„é€šé—œç´€éŒ„ã€‚</p>
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mt-6"></div>
                </div>
            `;

            // --- Firebase ç´€éŒ„èˆ‡æ’åè¨ˆç®— ---
            const { rank, totalRecords } = await recordCompletionAndShowRank(isLate);

            document.body.className = 'min-h-screen flex items-center justify-center p-4 success-bg';
            container.className = 'bg-yellow-100 text-gray-900 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-yellow-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-700 mt-4 animate-bounce">
                        ä½ æˆåŠŸæ‰“é–‹é‡‘åº«ï¼
                    </h2>
                    <!-- é¡¯ç¤ºä»£è™Ÿèˆ‡æ™‚é–“ -->
                    <p class="text-xl font-bold mb-2">
                        ä»£è™Ÿ: <span class="text-red-600">${playerName}</span>
                    </p>
                    <p class="text-2xl font-extrabold mb-4 text-red-700">
                        è€—æ™‚: ${completionTime} ç§’
                    </p>
                    <!-- é¡¯ç¤ºæ’å -->
                    <p class="text-lg font-semibold mb-6 p-2 bg-yellow-200 rounded-lg shadow-md">
                        ğŸ‰ ä»Šæ—¥ç¬¬ <span class="text-red-700 font-extrabold">${rank}</span> ä½é€šé—œç©å®¶! (å…± ${totalRecords} ç­†ç´€éŒ„)
                    </p>

                    <!-- åœ–ç‰‡ä½”ä½ç¬¦ï¼šé‡‘å¹£æˆåŠŸåœ– -->
                    <img src="SUCCESS_IMAGE.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200x150/FFD700/000?text=é‡‘å¹£æˆåŠŸåœ–';"
                         alt="é‡‘å¹£æˆåŠŸåœ–" 
                         class="mx-auto w-1/2 max-w-sm object-contain mb-4 shadow-lg"
                    >
                    
                    <p class="mt-6 text-xl">
                        é‡‘å±±éŠ€å±±å°±åœ¨çœ¼å‰ï¼Œä½ å¾—æ‰‹äº†ï¼
                    </p>
                    <p class="mt-4 text-2xl font-bold p-3 bg-yellow-300 rounded-lg">
                        <strong>è«‹åˆ°ç°½åˆ°è™•å‡ºç¤ºé€™å€‹ç•«é¢é ˜å–ä½ çš„é‡‘å¹£ï¼</strong>
                    </p>
                </div>
            `;
            controlsDiv.innerHTML = '';
        }

        /**
         * éšæ®µ 4b: é²ä¾†æˆåŠŸç•«é¢ (æ™‚é–“æ­¸é›¶å¾Œæ‰å®Œæˆ)
         * æ–°å¢ï¼šFirebase ç´€éŒ„èˆ‡æ’åé¡¯ç¤º
         */
        async function goToLateSuccess(isLate) {
            currentState = GAME_STATE.SUCCESS; // ä»è¦–ç‚ºæˆåŠŸç‹€æ…‹

            // åœæ­¢ BGM ä¸¦æ’­æ”¾é²ä¾†éŸ³æ•ˆ
            bgm.pause();
            lateSound.play().catch(error => console.log("Late sound playback failed:", error));
            
            stopTimer();
            timerDisplay.classList.add('hidden'); 
            clearScreen();
            window.scrollTo(0, 0);

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            contentDiv.innerHTML = `
                <div class="text-center py-10">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-4">æ­£åœ¨è¨ˆç®—æ‚¨çš„æ’å...</h2>
                    <p class="text-lg text-gray-400">æ­£åœ¨ç­‰å¾…ä¼ºæœå™¨ç¢ºèªæ‚¨çš„é€šé—œç´€éŒ„ã€‚</p>
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mt-6"></div>
                </div>
            `;
            
            // --- Firebase ç´€éŒ„èˆ‡æ’åè¨ˆç®— ---
            const { rank, totalRecords } = await recordCompletionAndShowRank(isLate);

            document.body.className = 'min-h-screen flex items-center justify-center p-4 success-bg';
            container.className = 'bg-yellow-100 text-gray-900 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-yellow-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-700 mt-4 animate-bounce">
                        ä½ æˆåŠŸæ‰“é–‹é‡‘åº«ï¼
                    </h2>
                    <!-- é¡¯ç¤ºä»£è™Ÿèˆ‡æ™‚é–“ -->
                    <p class="text-xl font-bold mb-2">
                        ä»£è™Ÿ: <span class="text-red-600">${playerName}</span>
                    </p>
                    <p class="text-2xl font-extrabold mb-4 text-red-700">
                        è€—æ™‚: ${completionTime} ç§’
                    </p>
                    <!-- é¡¯ç¤ºæ’å -->
                    <p class="text-lg font-semibold mb-6 p-2 bg-yellow-200 rounded-lg shadow-md">
                        â±ï¸ ä»Šæ—¥ç¬¬ <span class="text-red-700 font-extrabold">${rank}</span> ä½é€šé—œç©å®¶! (å…± ${totalRecords} ç­†ç´€éŒ„)
                    </p>
                    
                    <!-- åœ–ç‰‡ä½”ä½ç¬¦ï¼šé‡‘å¹£ B åœ– (å·²ç§»é™¤åœ“è§’å’Œé‚Šæ¡†ï¼Œå¯¬åº¦ w-1/2 for mobile) -->
                    <img src="LATE_IMAGE.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200x150/FFD700/000?text=é‡‘å¹£Båœ–';"
                         alt="é‡‘å¹£Båœ–" 
                         class="mx-auto w-1/2 max-w-sm object-contain mb-4 shadow-lg"
                    >
                    <p class="mt-6 text-xl">
                        ä½†æ˜¯æ²’æƒ³åˆ°ä½ ä¾†çš„å¤ªæ™šäº†ï¼Œåªå‰©ä¸‹â‹¯â‹¯
                    </p>
                    <p class="mt-4 text-2xl font-bold p-3 bg-yellow-300 rounded-lg">
                        <strong>è«‹åˆ°ç°½åˆ°è™•å‡ºç¤ºé€™å€‹ç•«é¢é ˜å–ä½ çš„çå‹µï¼</strong>
                    </p>
                </div>
            `;
            controlsDiv.innerHTML = '';
        }


        /** éšæ®µ 5: å¤±æ•—ç•«é¢ */
        function gameOver() {
            currentState = GAME_STATE.FAIL;
            clearScreen();
            stopTimer();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢
            
            container.className = 'bg-red-900 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-red-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-red-400 mt-4">
                        è¡Œå‹•å¤±æ•—ï¼
                    </h2>
                    <p class="mt-6 text-xl">
                        æ›ç­çš„ä¿é¢å·²ç¶“åˆ°é”ï¼Œä½ è¢«æŠ“å€‹æ­£è‘—ã€‚é‡‘å¹£å¤¢ç¢ï¼
                    </p>
                    <p class="mt-4">
                        ä¸‹æ¬¡æº–å‚™æ›´å……åˆ†å†ä¾†å§ã€‚
                    </p>
                </div>
            `;
            renderButton("é‡æ–°é–‹å§‹", goToInitialImageScreen); // é‡æ–°å›åˆ°å°é¢é 
        }

        // --- å•Ÿå‹•éŠæˆ² ---
        // window.onload ç¾å·²ç”± onAuthStateChanged è™•ç†
        // å¦‚æœç€è¦½å™¨æ”¯æŒï¼Œæœƒåœ¨ <script type="module"> ä¸­èª¿ç”¨ initGame
        
    </script>
</body>
</html>
