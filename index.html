<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›² - Firebaseç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å’Œ Noto Sans TC ç¢ºä¿ä¸­è‹±æ–‡å­—é«”ç¾è§€ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯, ç¬¦åˆé»‘å¹«ä¸»é¡Œ */
        }
        .text-shadow-custom {
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .gold-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            font-weight: 700;
        }
        .gold-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        .gold-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        /* æˆåŠŸç•«é¢ç‰¹æ•ˆ */
        .success-bg {
            background: radial-gradient(circle at center, #ffeb3b 0%, #ffc107 70%, #ff9800 100%);
            animation: pulse-gold 1.5s infinite alternate;
        }
        @keyframes pulse-gold {
            from { filter: brightness(1.0); }
            to { filter: brightness(1.1); }
        }
        /* æ™‚é–“å¿«åˆ°æ™‚çš„é–ƒçˆæ•ˆæœ */
        .timer-warning {
            animation: flash-red 0.5s infinite alternate;
        }
        @keyframes flash-red {
            from { background-color: #8b0000; }
            to { background-color: #dc2626; }
        }
        /* æ–°å¢ï¼šå€’æ•¸å‰©ä¸‹ 2 åˆ†é˜æ™‚çš„æ”¾å¤§æ•ˆæœ */
        .timer-large {
            font-size: 1.5rem; /* è®Šå¤§ */
            padding: 0.75rem; /* å¢åŠ å…§é‚Šè· */
            border: 3px solid #ffeb3b; /* å¢åŠ é‚Šæ¡†å¼·èª¿ */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transition: all 0.3s ease-in-out;
        }
        /* æ•˜äº‹æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
        .fade-transition {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .fade-in {
            opacity: 1;
        }
        .fade-out {
            opacity: 0;
        }
        /* è€å¤§é¸æ“‡ä»‹é¢æ¨£å¼ */
        .boss-item {
            aspect-ratio: 1 / 1;
        }
        .boss-check {
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* è¼‰å…¥ç•«é¢æ¨£å¼ */
        #firebase-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(26, 26, 46, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #ffeb3b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Firebase è¼‰å…¥ç•«é¢ -->
    <div id="firebase-loading">
        <div class="spinner mb-4"></div>
        <p class="text-white text-lg">æ­£åœ¨å»ºç«‹ç§˜å¯†é€£ç·š (Firebase)...</p>
    </div>

    <!-- èƒŒæ™¯éŸ³æ¨‚ -->
    <audio id="bgm" loop>
        <source src="Mission Impossible Theme (Full Theme).mp3" type="audio/mp3">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾ã€‚
    </audio>

    <!-- æˆåŠŸéŸ³æ•ˆ -->
    <audio id="success-sound">
        <source src="SUCCESS_Sound.mp4" type="audio/mp4">
    </audio>
    <!-- é²ä¾†æˆåŠŸéŸ³æ•ˆ -->
    <audio id="late-sound">
        <source src="LATE_sound.mp4" type="audio/mp4">
    </audio>

    <!-- ä¸»éŠæˆ²å®¹å™¨ -->
    <div id="game-container" class="bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500">
        
        <!-- æ¨™é¡Œ -->
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-yellow-400 text-shadow-custom">
            é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›²
        </h1>

        <!-- è¨ˆæ™‚å™¨é¡¯ç¤ºå€å¡Š -->
        <div id="timer-display" class="text-center text-xl font-mono p-2 mb-4 rounded-lg bg-red-800 text-yellow-300 shadow-inner hidden">
            <!-- å‰©é¤˜æ™‚é–“: 10:00 -->
        </div>

        <!-- å…§å®¹å€å¡Š -->
        <div id="game-content" class="text-lg space-y-4">
            <!-- éŠæˆ²å…§å®¹å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- äº’å‹•å€å¡Š -->
        <div id="game-controls" class="mt-8 flex flex-col space-y-4">
            <!-- æŒ‰éˆ•å’Œè¼¸å…¥æ¡†å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- è¨Šæ¯å€å¡Š (ç”¨æ–¼æç¤ºéŒ¯èª¤æˆ–æˆåŠŸ) -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-center font-bold hidden"></div>

    </div>

    <!-- Firebase SDK å¼•ç”¨ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, onSnapshot, collection, query, where, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- å…¨åŸŸ Firebase ç‹€æ…‹è®Šæ•¸ ---
        let app, db, auth, userId = 'anonymous';
        let isFirebaseInitialized = false;

        // Configuration variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        const loadingScreen = document.getElementById('firebase-loading');
        const container = document.getElementById('game-container'); // é‡æ–°å–å¾—å®¹å™¨

        // A helper function to show a fatal error on the main screen
        function showFatalError(message) {
            loadingScreen.style.display = 'none'; // Hide the loading screen
            container.innerHTML = `
                <div class="text-center p-8 bg-red-900 rounded-lg border-2 border-red-500">
                    <h2 class="text-3xl font-bold text-red-300 mb-4">âŒ è³‡æ–™åº«é€£ç·šå¤±æ•—</h2>
                    <p class="text-lg text-white mb-4">${message}</p>
                    <p class="text-sm text-gray-300">è«‹å˜—è©¦åˆ·æ–°é é¢æˆ–ç¨å¾Œå†è©¦ã€‚</p>
                </div>
            `;
            // Ensure the main container is visible and styled for error
            container.className = 'bg-red-900 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';
            document.body.className = 'min-h-screen flex items-center justify-center p-4 bg-gray-900';
        }

        // Initialize and Authenticate Firebase
        async function initializeFirebase() {
            try {
                if (!firebaseConfig) {
                    // *** é—œéµä¿®å¾©é» 1ï¼šå¦‚æœç’°å¢ƒè®Šæ•¸æ²’æœ‰æä¾›è¨­å®šï¼Œç›´æ¥é¡¯ç¤ºè‡´å‘½éŒ¯èª¤ ***
                    console.error("Firebase configuration is missing or invalid from environment.");
                    showFatalError("ç³»çµ±ç„¡æ³•å–å¾— Firebase é€£ç·šè¨­å®šã€‚");
                    return;
                }
                
                // setLogLevel('debug'); // é–‹å•Ÿè©³ç´°æ—¥èªŒä»¥ä¾›åµéŒ¯
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // åŸ·è¡Œèº«ä»½é©—è­‰ï¼šå„ªå…ˆä½¿ç”¨ custom tokenï¼Œå¦å‰‡åŒ¿åç™»å…¥
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // é¦–æ¬¡æª¢æŸ¥å¾Œåœæ­¢ç›£è½
                        if (user) {
                            userId = user.uid;
                            console.log("Authenticated user:", userId);
                            resolve();
                        } else {
                            if (typeof __initial_auth_token !== 'undefined') {
                                try {
                                    const userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                                    userId = userCredential.user.uid;
                                    console.log("Signed in with custom token:", userId);
                                } catch (error) {
                                    console.error("Custom token sign-in failed. Falling back to anonymous.", error);
                                    const userCredential = await signInAnonymously(auth);
                                    userId = userCredential.user.uid;
                                }
                            } else {
                                const userCredential = await signInAnonymously(auth);
                                userId = userCredential.user.uid;
                                console.log("Signed in anonymously:", userId);
                            }
                            resolve();
                        }
                    });
                });
                
                isFirebaseInitialized = true;
                console.log("Firebase initialized and authenticated.");
                // éš±è—è¼‰å…¥ç•«é¢
                loadingScreen.style.opacity = 0;
                setTimeout(() => loadingScreen.style.display = 'none', 500);

            } catch (error) {
                // *** é—œéµä¿®å¾©é» 2ï¼šå¦‚æœé€£ç·šå¤±æ•— (ä¾‹å¦‚æ¬Šé™æˆ–ç¶²è·¯å•é¡Œ)ï¼Œé¡¯ç¤ºé€£ç·šéŒ¯èª¤ ***
                console.error("Firebase initialization failed due to connection error:", error);
                showFatalError(`é€£ç·šéŒ¯èª¤: ${error.message || 'ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ã€‚'}`);
            }
        }
        
        /** å–å¾—ä»Šå¤©çš„æ—¥æœŸå­—ä¸² YYYY-MM-DD */
        function getTodayDateString() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /** å°‡é€šé—œç´€éŒ„å„²å­˜åˆ° Firestore */
        async function saveScore() {
            if (!isFirebaseInitialized || !db) {
                console.error("Firebase not ready. Cannot save score.");
                showMessage("åˆ†æ•¸å„²å­˜å¤±æ•—ï¼šFirebaseå°šæœªé€£ç·šã€‚", true);
                return;
            }

            const todayDate = getTodayDateString();
            // å…¬é–‹è³‡æ–™ Collection è·¯å¾‘
            const dailyScoresCollectionPath = `artifacts/${appId}/public/data/daily_scores`;
            const scoresRef = collection(db, dailyScoresCollectionPath);
            
            try {
                // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰ä»Šæ—¥ç´€éŒ„ (ä½¿ç”¨ userId å’Œ date æŸ¥è©¢)
                const q = query(scoresRef, 
                    where("userId", "==", userId),
                    where("date", "==", todayDate)
                );
                const existingDocs = await getDocs(q);

                if (existingDocs.docs.length > 0) {
                    // å¦‚æœç”¨æˆ¶ä»Šå¤©å·²ç¶“æœ‰ç´€éŒ„
                    const existingDoc = existingDocs.docs[0];
                    const existingTime = existingDoc.data().completionTime;
                    
                    if (completionTime < existingTime) {
                         // 2. å¦‚æœæ–°ç´€éŒ„æ›´å¿«ï¼Œå‰‡æ›´æ–°
                         await setDoc(existingDoc.ref, {
                            completionTime: completionTime,
                            timestamp: serverTimestamp(),
                        }, { merge: true });
                        console.log("Updated high score for today.");
                    } else {
                        // 3. å¦‚æœèˆŠç´€éŒ„æ›´å¿«ï¼Œå‰‡ä½¿ç”¨èˆŠç´€éŒ„çš„æ™‚é–“ä¾†æ’å
                        completionTime = existingTime;
                        console.log("Existing score is faster. Skip update, use existing time for ranking.");
                    }
                } else {
                    // 4. å¦å‰‡æ–°å¢ä¸€ç­†æ–°çš„ç´€éŒ„
                    const newDoc = {
                        playerName: playerName,
                        completionTime: completionTime, // å–®ä½ï¼šç§’
                        timestamp: serverTimestamp(),
                        userId: userId,
                        date: todayDate,
                        bossId: selectedBossId 
                    };
                    await addDoc(scoresRef, newDoc);
                    console.log("New score added successfully.");
                }

                // å„²å­˜å¾Œç«‹å³ç²å–ä¸¦é¡¯ç¤ºæ’å (ä½¿ç”¨ onSnapshot å¯¦ç¾å³æ™‚æ›´æ–°)
                fetchAndDisplayRankings();

            } catch (error) {
                console.error("Failed to save or check score:", error);
                showMessage("åˆ†æ•¸å„²å­˜å¤±æ•—ï¼Œè«‹æˆªåœ–å¾Œè¯ç¹«å·¥ä½œäººå“¡ï¼", true);
            }
        }

        /** ç²å–ä¸¦é¡¯ç¤ºç•¶æ—¥æ’è¡Œæ¦œå’Œç©å®¶æ’å (å³æ™‚ç›£è½) */
        function fetchAndDisplayRankings() {
            if (!isFirebaseInitialized || !db) {
                console.error("Firebase not ready. Cannot fetch rankings.");
                return;
            }
            
            const todayDate = getTodayDateString();
            const dailyScoresCollectionPath = `artifacts/${appId}/public/data/daily_scores`;
            const scoresRef = collection(db, dailyScoresCollectionPath);
            
            const leaderboardDiv = document.getElementById('leaderboard-area');
            if (!leaderboardDiv) return;
            
            // è¨­ç½® onSnapshot ç›£è½å™¨ä»¥ç²å–ä»Šæ—¥æ’è¡Œæ¦œ
            const q = query(scoresRef, where("date", "==", todayDate));
            
            // onSnapshot æœƒåœ¨è³‡æ–™æœ‰è®Šå‹•æ™‚è‡ªå‹•åŸ·è¡Œ
            const unsubscribe = onSnapshot(q, (snapshot) => {
                let allScores = [];
                snapshot.forEach((doc) => {
                    allScores.push({ id: doc.id, ...doc.data() });
                });

                // 2. å®¢æˆ¶ç«¯æ’åºï¼šä¾æ“š completionTime å‡å†ªæ’åˆ— (æ™‚é–“çŸ­çš„æ’å‰é¢)
                allScores.sort((a, b) => a.completionTime - b.completionTime);

                
                // 3. ç¢ºå®šç©å®¶çš„æ’å
                let playerRank = -1;
                let playerBestTime = completionTime; 
                let playerEntry = allScores.find(score => score.userId === userId);
                
                if (playerEntry) {
                    playerBestTime = playerEntry.completionTime;
                    playerRank = allScores.findIndex(score => score.userId === userId) + 1;
                } else {
                    // ç†è«–ä¸Š saveScore åŸ·è¡Œå¾Œä¸€å®šæœƒæœ‰ç´€éŒ„ï¼Œé™¤éç¶²è·¯å»¶é²
                    playerRank = -1; 
                }
                
                // 4. æ¸²æŸ“çµæœ
                let rankingHTML = `
                    <div class="p-4 bg-gray-800 rounded-lg shadow-xl mb-4">
                        <p class="text-xl font-bold text-yellow-400">é€šé—œçµæœ</p>
                        <p class="text-3xl font-extrabold text-red-500 mt-2">
                            ä½ æ˜¯ç¬¬ <span class="text-5xl">${playerRank !== -1 ? playerRank : '...'}</span> ä½æˆåŠŸæŒ‘æˆ°çš„ç‰¹å‹™ï¼
                        </p>
                        <p class="text-md text-gray-300 mt-1">
                            ä½ ä»Šæ—¥æœ€ä½³ç´€éŒ„ï¼š${playerBestTime} ç§’
                        </p>
                        <p class="text-sm text-gray-400 mt-2">
                            <span class="font-bold">ä»Šæ—¥æ’è¡Œ (${todayDate}) (å³æ™‚æ›´æ–°):</span>
                        </p>
                        <ul class="mt-2 space-y-2 max-h-48 overflow-y-auto pr-2">
                `;

                // é¡¯ç¤ºå‰ 10 å
                allScores.slice(0, 10).forEach((score, index) => {
                    const rank = index + 1;
                    const isPlayer = score.userId === userId;
                    // å¦‚æœç©å®¶ç´€éŒ„çš„æ™‚é–“å’Œè©²åæ¬¡æ™‚é–“ä¸€è‡´ (æœ‰å¯èƒ½å¤šäººåŒç§’)ï¼Œå‰‡é«˜äº®
                    const isHighlighted = isPlayer || (score.completionTime === playerBestTime && rank === playerRank);
                    const rankClass = rank === 1 ? 'text-amber-500 text-lg font-bold' : (isHighlighted ? 'text-green-400 font-bold' : 'text-gray-200');
                    
                    rankingHTML += `
                        <li class="flex justify-between items-center p-2 rounded-md ${isHighlighted ? 'bg-green-900 border border-green-500' : 'bg-gray-700'}">
                            <span class="${rankClass}">#${rank} ${score.playerName}</span>
                            <span class="text-yellow-300">${score.completionTime} ç§’</span>
                        </li>
                    `;
                });
                
                if (allScores.length === 0) {
                     rankingHTML += `<li class="text-gray-400 text-center py-4">ä»Šæ—¥å°šæœªæœ‰é€šé—œç´€éŒ„ã€‚</li>`;
                }

                rankingHTML += `
                        </ul>
                    </div>
                `;
                
                leaderboardDiv.innerHTML = rankingHTML;
                
                // ç‚ºäº†é¿å…è¨˜æ†¶é«”æ´©æ¼ï¼Œç•¶éŠæˆ²é‡å•Ÿæ™‚ï¼Œæ‡‰è©²å–æ¶ˆé€™å€‹ç›£è½ã€‚
                // é€™è£¡æš«æ™‚ä¸åšå–æ¶ˆï¼Œå› ç‚º onSnapshot æœƒåœ¨é é¢é—œé–‰æ™‚è‡ªå‹•åœæ­¢ã€‚

            }, (error) => {
                console.error("Error fetching daily scores:", error);
                leaderboardDiv.innerHTML = `<div class="text-red-400 p-4 bg-gray-700 rounded-lg">è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</div>`;
            });
        }

        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        const GAME_STATE = {
            START: 0,       
            VAULT_LOCATE: 1, 
            CLUE_HUNT: 2,    
            CODE_ENTRY: 3,   
            SUCCESS: 4,      
            FAIL: 5          
        };

        const CORRECT_CLUE = "é‡‘åº«å®ˆå‰‡";
        const CORRECT_CODE = "275"; 
        
        // è¨ˆæ™‚å™¨è¨­å®š (10 åˆ†é˜ = 600 ç§’)
        const INITIAL_TIME_SECONDS = 600;
        let timerInterval = null;
        let timeLeft = INITIAL_TIME_SECONDS;

        let currentState = GAME_STATE.START;
        
        // *** å…¨åŸŸè®Šæ•¸ï¼šç©å®¶åç¨±ã€è€å¤§é¸æ“‡ã€æ™‚é–“è¨˜éŒ„ ***
        let playerName = "";
        let selectedBossId = null; 
        let missionStartTime = 0; // ä»»å‹™é–‹å§‹æ™‚é–“ (Date.now())
        let completionTime = 0;   // æœ€çµ‚é€šé—œæ™‚é–“ (ç§’)

        // å¯†ç¢¼æç¤ºç›¸é—œ
        let hintsRevealed = 0; 
        
        // *** HINTS é™£åˆ—å…§å®¹ ***
        const HINTS = [
            "ä½ æœ‰ç™¼ç¾é‡‘åº«ä¸Šé¢çš„æç¤ºã€Œè€å¤§æ‰èƒ½ç¢°ã€ï¼Œè€å¤§åœ¨è³­å ´è£¡çš„èŠ±è‰²é€šå¸¸æ˜¯ä»£è¡¨ã€é»‘æ¡ƒã€ï¼Œä½†æ˜¯é‡‘åº«å®ˆå‰‡ä¸Šä¼¼ä¹ä¸åªæœ‰ä¸€ç¨®é¡è‰²çš„ã€é»‘æ¡ƒã€â‹¯â‹¯",
            "é‡‘åº«å®ˆå‰‡ä¸Šä¼¼ä¹æœ‰å¾ˆå¤šä¸åŒé¡è‰²çš„ç­†ç•«ï¼Œä»”ç´°çœ‹çœ‹å¥½åƒæ˜¯æ•¸å­—â‹¯â‹¯ä¹Ÿè¨±é€™è·Ÿå¯†ç¢¼æœ‰ä»€éº¼é—œä¿‚ï¼Ÿ",
            "é‡‘åº«å¯†ç¢¼æ˜¯ä¸‰ä½æ•¸ï¼Œç´…è‰²çš„é»‘æ¡ƒä¹Ÿæ˜¯ä¸‰å€‹â‹¯â‹¯å‰©ä¸‹å°±æ˜¯æ¯å€‹é»‘æ¡ƒåˆ†åˆ¥ä»£è¡¨å“ªå€‹æ•¸å­—äº†â‹¯â‹¯"
        ];
        // *** HINTS é™£åˆ—çµæŸ ***

        // *** å°è©±å…§å®¹ (ç”±è€å¤§æ•˜äº‹) ***
        let currentDialogueStep = 0; 
        const DIALOGUE_STEPS = (name) => [
            { speaker: 'BOSS', text: `<span class="text-red-400">${name}</span>ä½ ä¾†å•¦â‹¯â‹¯`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'PLAYER', text: `è€å¤§ï¼æœ‰ä½•å©å’ï¼Ÿ`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'BOSS', text: `ä½ è¢«é‚€è«‹åˆ°é€™å ´ç”±é»‘å¹«èˆ‰è¾¦çš„è³­å ´å®´æœƒï¼Œè¡¨é¢ä¸Šæ˜¯ä¾†ä¸€æ“²åƒé‡‘çš„å®¢äººï¼Œä½†ä½ çœŸæ­£çš„ç›®æ¨™æ˜¯è³­å ´å¾Œé¢çš„é‚£åº§<span class="text-yellow-500 font-bold">é‡‘åº«</span>ï¼`, buttonText: "ç¹¼çºŒ" },
            { 
                speaker: 'BOSS', 
                text: `ä»Šå¤©å¾ˆå¤šå…¶ä»–é»‘å¹«æˆå“¡ä¹Ÿæ˜¯æ‰“è‘—è·Ÿä½ ä¸€æ¨£çš„ä¸»æ„ï¼Œä½ å¿…é ˆçˆ­åˆ†å¥ªç§’ï¼Œç›¡å¿«æŠŠé‡‘åº«æ‰“é–‹ï¼Œ<span class="text-yellow-400 font-bold">ä¸ç„¶è£¡é¢çš„é‡‘å¹£æœƒè¢«å…¶ä»–äººæ·è¶³å…ˆç™»ï¼</span>`, 
                buttonText: "ç¹¼çºŒ" 
            },
            {
                speaker: 'BOSS',
                text: `ç¾åœ¨ï¼Œä½ è¶ä¿é¢åœ¨æ‰“çŒç¡ï¼Œå·²ç¶“å·å·æ½›å…¥åˆ°äº†è³­å ´çš„é‡‘åº«ä½ç½®ã€‚<br>å™“ï¼å°å¿ƒä¸è¦è¢«ç™¼ç¾ï¼<br><span class="text-yellow-400 font-bold">ååˆ†é˜å…§</span>ä½ å¿…é ˆè§£å‡ºé€™å€‹è¬é¡Œï¼Œä¸ç„¶æ›ç­çš„äººå°±è¦ä¾†äº†ï¼Œä½ æœƒè¢«æŠ“å€‹æ­£è‘—ï¼<br>ä»”ç´°æŸ¥çœ‹é‡‘åº«åœ¨å“ªè£¡ï¼Ÿé‚„æœ‰å¯†ç¢¼ï¼Œä½ éœ€è¦çŸ¥é“å¯†ç¢¼æ˜¯å¹¾ä½æ•¸ã€‚`,
                buttonText: "å·å·æ½›å…¥é‡‘åº«",
                action: 'START_MISSION'
            }
        ];
        
        // DOM å…ƒç´ 
        // å·²ç¶“åœ¨æª”æ¡ˆé ‚éƒ¨å®šç¾©äº† const container = document.getElementById('game-container');
        const contentDiv = document.getElementById('game-content');
        const controlsDiv = document.getElementById('game-controls');
        const messageArea = document.getElementById('message-area');
        const timerDisplay = document.getElementById('timer-display');
        const bgm = document.getElementById('bgm'); 
        const successSound = document.getElementById('success-sound'); 
        const lateSound = document.getElementById('late-sound');     


        // --- éŸ³æ¨‚æ’­æ”¾é‚è¼¯ ---
        function startBGM() {
            if (bgm && bgm.paused) {
                bgm.volume = 0.5;
                console.log("BGM å˜—è©¦å•Ÿå‹•: Mission Impossible Theme");
                bgm.play().catch(error => {
                    console.log("BGM è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ã€‚", error);
                });
            }
        }

        // --- è¨ˆæ™‚å™¨é‚è¼¯ ---
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function updateTimer() {
            if (timeLeft < 0) {
                timeLeft = 0;
            }
            timerDisplay.textContent = `å‰©é¤˜æ™‚é–“: ${formatTime(timeLeft)}`;

            if (timeLeft <= 120 && timeLeft > 0) {
                timerDisplay.classList.add('timer-large');
            } else {
                timerDisplay.classList.remove('timer-large');
            }

            if (timeLeft <= 60 && timeLeft > 0) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.remove('timer-warning');
            }

            if (timeLeft <= 0) {
                stopTimer();
                timerDisplay.textContent = "æ™‚é–“åˆ°ï¼æ›ç­ä¿é¢å·²åˆ°ï¼Œè«‹å¿«é€Ÿå®Œæˆå¯†ç¢¼è¼¸å…¥ã€‚";
                return;
            }
            timeLeft--;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = INITIAL_TIME_SECONDS;
            timerDisplay.classList.remove('hidden');
            updateTimer(); 
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }


        // --- è¼”åŠ©å‡½æ•¸ ---

        function showMessage(text, isError = false) {
            messageArea.textContent = text;
            messageArea.className = `mt-4 p-3 rounded-lg text-center font-bold ${isError ? 'bg-red-700' : 'bg-green-700'}`;
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 3000);
        }

        function clearScreen() {
            contentDiv.innerHTML = '';
            controlsDiv.innerHTML = '';
        }

        function renderButton(text, onClick, isFinalStep = false, id = null) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full';
            button.onclick = onClick;
            if (id) button.id = id;
            controlsDiv.appendChild(button);
        }

        function renderInput(placeholder, buttonText, onSubmit, inputId, maxLength) {
            const constContainer = document.createElement('div');
            constContainer.className = 'flex flex-col space-y-3';
            
            const input = document.createElement('input');
            input.id = inputId;
            input.type = 'text';
            input.maxLength = maxLength || 50;
            input.placeholder = placeholder;
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400';
            
            const button = document.createElement('button');
            button.textContent = buttonText;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg';
            button.onclick = () => onSubmit(document.getElementById(inputId).value);

            input.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    onSubmit(document.getElementById(inputId).value);
                }
            });

            constContainer.appendChild(input);
            constContainer.appendChild(button);
            controlsDiv.appendChild(constContainer);
        }

        function revealHint() {
            if (hintsRevealed >= HINTS.length) {
                showMessage("å·²ç¶“æ²’æœ‰æ›´å¤šæç¤ºäº†ï¼", true);
                return;
            }
            const timeDeduction = 60;
            if (timeLeft - timeDeduction <= 0) {
                timeLeft = 0; 
                showMessage("æ™‚é–“ç”¨ç›¡ï¼ä½ ç„¡æ³•å†ç²å–æç¤ºäº†ã€‚", true);
                updateTimer();
            } else {
                timeLeft -= timeDeduction;
                showMessage(`æ‰£é™¤ ${timeDeduction} ç§’ã€‚è«‹åƒè€ƒæ–°æç¤ºã€‚`, false);
                updateTimer();
            }
            
            const hintText = HINTS[hintsRevealed];
            const hintDiv = document.getElementById('hint-messages');
            
            const p = document.createElement('p');
            p.className = "mt-2 p-3 bg-gray-700 rounded-lg border border-red-500 transition-all duration-300 transform scale-100 hover:scale-[1.02]";
            p.innerHTML = `<span class="text-red-400 font-bold">[æç¤º #${hintsRevealed + 1} (-60ç§’)]</span>: ${hintText}`;
            hintDiv.appendChild(p);
            hintsRevealed++;
            
            const hintButton = document.getElementById('reveal-hint-button');
            if (hintsRevealed >= HINTS.length) {
                hintButton.textContent = "å·²ç„¡æ›´å¤šæç¤º";
                hintButton.disabled = true;
                hintButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                hintButton.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else {
                hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            }
        }

        // --- æ•˜äº‹å’Œæµç¨‹æ§åˆ¶ ---

        /** é€æ­¥é¡¯ç¤ºå°è©±å…§å®¹ */
        function displayNextDialogue() {
            const dialogueData = DIALOGUE_STEPS(playerName);
            if (currentDialogueStep >= dialogueData.length) {
                goToVaultLocate();
                return;
            }

            const step = dialogueData[currentDialogueStep];

            // 1. æ·¡å‡ºèˆŠå…§å®¹
            const currentContent = document.getElementById('dialogue-wrapper');
            if (currentContent) {
                currentContent.classList.remove('fade-in');
                currentContent.classList.add('fade-out');
            }
            
            // 2. å»¶é²å¾Œæ›´æ–°å…§å®¹ä¸¦æ·¡å…¥
            setTimeout(() => {
                controlsDiv.innerHTML = '';
                
                let wrapper = document.getElementById('dialogue-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.id = 'dialogue-wrapper';
                    wrapper.className = 'fade-transition space-y-4';
                    contentDiv.appendChild(wrapper);
                }
                
                // æ±ºå®šèªªè©±è€…æ¨£å¼
                const speakerClass = step.speaker === 'BOSS' ? 'text-yellow-400 font-bold' : 'text-green-400 font-bold';
                const speakerName = step.speaker === 'PLAYER' ? playerName : 'è€å¤§';

                wrapper.innerHTML = `
                    <div class="p-4 bg-gray-700 rounded-lg shadow-inner">
                        <p class="${speakerClass} mb-2">${speakerName}:</p>
                        <p class="text-gray-200">${step.text}</p>
                    </div>
                `;
                wrapper.classList.remove('fade-out');
                wrapper.classList.add('fade-in');
                
                // 3. æ¸²æŸ“æŒ‰éˆ•
                const buttonAction = () => {
                    if (step.action === 'START_MISSION') {
                        // è¨˜éŒ„ä»»å‹™é–‹å§‹çš„ç²¾ç¢ºæ™‚é–“
                        missionStartTime = Date.now(); 
                        startTimer(); 
                        goToVaultLocate(); 
                    } else {
                        currentDialogueStep++;
                        displayNextDialogue();
                    }
                };

                renderButton(step.buttonText, buttonAction);
                window.scrollTo(0, 0); 
            }, 1000); 
        }

        
        /**
         * å‰ç½®éšæ®µ: åˆå§‹åœ–ç‰‡ç•«é¢
         * æ–°å¢ï¼šå‹¾é¸æ¡†é©—è­‰é‚è¼¯
         */
        function goToInitialImageScreen() {
            clearScreen();
            stopTimer(); 
            timerDisplay.classList.add('hidden');

            document.body.className = 'min-h-screen flex items-center justify-center p-4 bg-gray-900';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <div class="text-center space-y-6">
                    <p class="text-lg text-gray-300">ä¸€å ´ç§˜å¯†è¡Œå‹•å³å°‡å±•é–‹...</p>
                    
                    <!-- åˆå§‹åœ–ç‰‡ï¼šcover.jpg -->
                    <img src="cover.jpg" 
                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/29294F/FFF?text=èµ·å§‹ç•«é¢åœ–ç‰‡';"
                         alt="èµ·å§‹ç•«é¢åœ–ç‰‡" 
                         class="mx-auto w-full max-w-sm rounded-lg shadow-xl border-2 border-yellow-500 object-cover"
                    >
                </div>
            `;
            
            // --- å‹¾é¸æ¡†å€åŸŸ ---
            const checkboxArea = document.createElement('div');
            checkboxArea.className = 'mt-6 space-y-3 text-left text-gray-200';
            checkboxArea.innerHTML = `
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-network" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹ç¢ºä¿ç¶²è·¯ç©©å®š</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-volume" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹æ‰“é–‹éŠæˆ²éŸ³é‡</span>
                </label>
            `;
            controlsDiv.appendChild(checkboxArea);

            // --- æŒ‰éˆ• ---
            const initialButton = document.createElement('button');
            initialButton.id = 'initial-start-button';
            initialButton.textContent = "é€²å…¥ç§˜å¯†ä»»å‹™";
            initialButton.disabled = true; // é è¨­ç¦ç”¨
            initialButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            controlsDiv.appendChild(initialButton);

            // --- æª¢æŸ¥å‡½æ•¸ ---
            function checkPreconditions() {
                const networkChecked = document.getElementById('check-network').checked;
                const volumeChecked = document.getElementById('check-volume').checked;

                const isReady = networkChecked && volumeChecked;
                initialButton.disabled = !isReady;

                if (isReady) {
                    initialButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    messageArea.classList.add('hidden');
                } else {
                    initialButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                }
            }

            // --- ç›£è½å‹¾é¸æ¡† ---
            document.getElementById('check-network').addEventListener('change', checkPreconditions);
            document.getElementById('check-volume').addEventListener('change', checkPreconditions);

            // --- è™•ç†æŒ‰éˆ•é»æ“Š (å³ä½¿è¢«ç¦ç”¨ä¹Ÿéœ€è¦æª¢æŸ¥) ---
            initialButton.onclick = () => {
                if (!initialButton.disabled) {
                    goToBossSelection();
                } else {
                    showMessage("è«‹ç¢ºä¿ä¸Šæ–¹å…©é …çš†å·²ç¢ºèª", true);
                }
            };
        }

        /** æ–°å¢ï¼šè€å¤§é¸æ“‡é é¢ */
        function goToBossSelection() {
            clearScreen();
            window.scrollTo(0, 0);
            selectedBossId = null; // é‡ç½®é¸æ“‡

            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-4">ä½ çš„è€å¤§æ˜¯ï¼Ÿ</h2>
                <p class="text-sm text-gray-400 text-center mb-6">*äººç‰©ä¸å½±éŸ¿æ•…äº‹é€²è¡Œ</p>
                
                <div id="boss-grid" class="grid grid-cols-3 gap-2">
                    <!-- è€å¤§åœ–ç‰‡å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ -->
                </div>
            `;
            
            const confirmButton = document.createElement('button');
            confirmButton.id = 'confirm-boss-button';
            confirmButton.textContent = "æˆ‘çš„è€å¤§æ˜¯ä»–/å¥¹"; 
            confirmButton.disabled = true; // é è¨­ç¦ç”¨
            confirmButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            
            confirmButton.onclick = goToNameInput;
            controlsDiv.appendChild(confirmButton);


            // --- åœ–ç‰‡æ¸²æŸ“å’Œé¸æ“‡é‚è¼¯ ---
            const bosses = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const gridDiv = document.getElementById('boss-grid');

            bosses.forEach(id => {
                const item = document.createElement('div');
                item.className = 'boss-item relative cursor-pointer border-4 border-transparent rounded-lg overflow-hidden transition-all duration-200 hover:border-yellow-500';
                item.setAttribute('data-boss-id', id);
                item.onclick = () => selectBoss(id);

                item.innerHTML = `
                    <img src="boss_${id}.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/100x100/3A3A3A/FFF?text=Boss%20${id}';"
                         alt="è€å¤§ ${id}" 
                         class="w-full h-full object-cover rounded-md"
                    >
                    <div id="check-${id}" class="boss-check absolute inset-0 bg-black/50 flex items-center justify-center text-4xl text-yellow-400">
                        âœ“
                    </div>
                `;
                gridDiv.appendChild(item);
            });
            
            function selectBoss(id) {
                selectedBossId = id;
                document.querySelectorAll('.boss-item').forEach(item => {
                    const itemId = parseInt(item.getAttribute('data-boss-id'));
                    const check = item.querySelector('.boss-check');
                    if (itemId === id) {
                        item.classList.add('border-yellow-400');
                        check.classList.add('opacity-100');
                    } else {
                        item.classList.remove('border-yellow-400');
                        check.classList.remove('opacity-100');
                    }
                });

                // å•Ÿç”¨æŒ‰éˆ•
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                confirmButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            }
        }

        /** æ–°å¢ï¼šåç¨±è¼¸å…¥é é¢ */
        function goToNameInput() {
            clearScreen();
            window.scrollTo(0, 0);
            
            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-6">å‘Šè¨´è€å¤§ä½ çš„ä»£è™Ÿ</h2>
                <p class="text-md text-gray-400 text-center">é€™æ˜¯ä½ ç¨ä¸€ç„¡äºŒçš„èº«ä»½ï¼Œå°‡ç”¨æ–¼ç´€éŒ„ä½ çš„é€šé—œé †åºã€‚</p>
                <p class="text-sm text-gray-500 text-center mt-2">ï¼ˆä½ çš„ä½¿ç”¨è€… ID: ${userId}ï¼‰</p>
            `;

            // å®šç¾©æäº¤åç¨±çš„å‡½æ•¸
            const submitName = (name) => {
                const trimmedName = name.trim();
                if (trimmedName.length >= 2 && trimmedName.length <= 10) {
                    playerName = trimmedName;
                    showMessage(`ä»£è™Ÿï¼š${playerName}ï¼Œç¢ºèªï¼`, false);
                    setTimeout(goToMissionDialogue, 1500); // é€²å…¥æ–°çš„å°è©±å ´æ™¯
                } else {
                    showMessage("ä»£è™Ÿé•·åº¦éœ€åœ¨ 2 åˆ° 10 å€‹å­—å…ƒä¹‹é–“ã€‚", true);
                }
            };

            // æ¸²æŸ“è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•
            renderInput("è«‹è¼¸å…¥ä½ çš„é»‘å¹«åŒ–åï¼ˆ2-10å€‹å­—ï¼‰", "ç¢ºèªä»£è™Ÿ", submitName, 'codename-input', 10); 
            document.getElementById('codename-input').focus();
        }

        /** æ–°å¢ï¼šå°è©±å ´æ™¯å…¥å£ */
        function goToMissionDialogue() {
            currentState = GAME_STATE.START;
            clearScreen();
            stopTimer();
            hintsRevealed = 0;
            timerDisplay.classList.add('hidden'); 
            
            // BGM åœ¨é€™è£¡å•Ÿå‹•
            startBGM(); 
            
            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';

            // é¡¯ç¤ºè€å¤§åœ–ç‰‡
            contentDiv.innerHTML = `
                <div class="text-center mb-6">
                    <img src="boss_${selectedBossId}.png" 
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/3A3A3A/FFF?text=BOSS';"
                         alt="é¸å®šçš„è€å¤§" 
                         class="mx-auto w-32 h-32 object-cover rounded-full shadow-lg border-4 border-red-500"
                    >
                </div>
                <div id="dialogue-content-area" class="space-y-4">
                    <!-- å°è©±å…§å®¹å°‡åœ¨æ­¤è™•é¡¯ç¤º -->
                </div>
            `;
            
            const dialogueArea = document.getElementById('dialogue-content-area');
            const wrapper = document.createElement('div');
            wrapper.id = 'dialogue-wrapper';
            wrapper.className = 'fade-transition space-y-4';
            dialogueArea.appendChild(wrapper);

            currentDialogueStep = 0; // é‡ç½®å°è©±æ­¥é©Ÿ
            displayNextDialogue(); // é–‹å§‹é¡¯ç¤ºç¬¬ä¸€æ®µå°è©±
        }

        /** éšæ®µ 1: ç¢ºèªå¯†ç¢¼ä½æ•¸ */
        function goToVaultLocate() {
            currentState = GAME_STATE.VAULT_LOCATE;
            clearScreen();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢

            contentDiv.innerHTML = `
                <p>ä½ ç¾åœ¨å·²ç¶“æˆåŠŸæ½›å…¥è³­å ´æ”¾<span class="text-yellow-500 font-bold">é‡‘åº«</span>çš„åœ°æ–¹ï¼è¶•å¿«æ‰¾æ‰¾é‡‘åº«åœ¨å“ªè£¡ï¼Ÿ</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸€æ­¥ã€‘</strong></p>
                <p>ä»”ç´°è§€å¯Ÿç¾å¯¦ä¸–ç•Œä¸­çš„é‡‘åº«å¯¶ç®±ï¼Œ<strong>å¯†ç¢¼é–æ˜¯å¹¾ä½æ•¸ï¼Ÿ</strong></p>
            `;

            renderInput("è«‹è¼¸å…¥å¯†ç¢¼é–çš„ä½æ•¸ (æ•¸å­—)", "ç¢ºèªä½æ•¸", checkVaultDigits, 'digit-input', 1);
            document.getElementById('digit-input').type = 'number';
        }

        /** æª¢æŸ¥å¯†ç¢¼ä½æ•¸æ˜¯å¦æ­£ç¢º (3) */
        function checkVaultDigits(input) {
            const digitInput = parseInt(input.trim());
            
            if (digitInput === 3) {
                showMessage("æ•¸å­—æ­£ç¢ºï¼ä½ ç™¼ç¾äº†é‡‘åº«å¯†ç¢¼æ˜¯ä¸‰ä½æ•¸å¯†ç¢¼é–ã€‚", false);
                setTimeout(() => {
                    window.scrollTo(0, 0); 
                    goToClueHunt();
                }, 2500);
                return;
            }

            // æä¾›å¼•å°æç¤º
            let hintMessage = "é€™å€‹ä½æ•¸ä¸æ­£ç¢ºã€‚";
            if (isNaN(digitInput) || digitInput === 0) {
                hintMessage = "è«‹è¼¸å…¥ä¸€å€‹æ•¸å­—ã€‚ä½ éœ€è¦æ‰¾åˆ°é‡‘åº«å¯¶ç®±ï¼Œä¸Šé¢æ‡‰è©²æœ‰å¯†ç¢¼é–ã€‚";
            } else if (digitInput > 4) {
                hintMessage = `é€™å€‹æ•¸å­—å¤ªå¤§äº†ã€‚å†ä»”ç´°çœ‹çœ‹ï¼Œé€™å€‹é–çš„çµæ§‹ä¼¼ä¹å¾ˆç°¡å–®ï¼Œåªé å¹¾å€‹è½‰ç›¤é‹ä½œã€‚`;
            } else if (digitInput === 2) {
                 hintMessage = `åªæœ‰å…©ä½æ•¸å—ï¼Ÿè«‹å†é è¿‘ä¸€é»æ•¸æ•¸çœ‹ï¼Œå¯†ç¢¼è½‰ç›¤æ˜¯ä¸æ˜¯æœ‰ä¸‰å€‹ï¼Ÿ`;
            } else if (digitInput === 4) {
                 hintMessage = `ä¸å°ï¼Œå®ƒä¸æ˜¯å››ä½æ•¸çš„ã€‚ä»”ç´°æ•¸æ•¸ï¼Œå¯†ç¢¼é–åªæœ‰ä¸‰å€‹å¯ä»¥è½‰å‹•çš„ç›¤ã€‚`;
            } else {
                hintMessage = "é€™å€‹ä½æ•¸ä¸æ­£ç¢ºã€‚è«‹å†æ¬¡ç¢ºèªé‡‘åº«å¯¶ç®±ä¸Šå¯†ç¢¼é–çš„æ•¸å­—è½‰ç›¤æ•¸é‡ã€‚";
            }
            
            showMessage(hintMessage, true);
        }

        /** éšæ®µ 2: å°‹æ‰¾ç·šç´¢ (æ‰¾é‡‘åº«å®ˆå‰‡) */
        function goToClueHunt() {
            currentState = GAME_STATE.CLUE_HUNT;
            clearScreen();
            window.scrollTo(0, 0); 

            contentDiv.innerHTML = `
                <p>ä½ ç¢ºèªäº†ï¼Œé‡‘åº«é–éœ€è¦<strong>ä¸‰ä½æ•¸å¯†ç¢¼</strong>æ‰èƒ½æ‰“é–‹ã€‚åŒæ™‚ï¼Œä½ ç™¼ç¾<strong>é‡‘åº«ä¸Šæœ‰ä¸€å€‹æç¤º</strong>å¯«è‘—ä»€éº¼â‹¯â‹¯ã€‚</p>
                <p>é‡‘åº«å¯†ç¢¼æ¯å¤©éƒ½æœƒæ›ï¼Œä½†ä½ äº‹å‰å·²ç¶“èª¿æŸ¥éï¼Œè³­å ´ä¸»äººè¨˜æ€§å¾ˆå·®ï¼Œ<strong>ç›¸é—œçš„æç¤ºä¸€å®šå°±åœ¨é‡‘åº«é™„è¿‘</strong>ã€‚</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬äºŒæ­¥ã€‘</strong></p>
                <p>ç’°é¡§å››å‘¨ï¼Œå°‹æ‰¾å‘¨é‚Šç‰©å“ï¼Œä»€éº¼æ±è¥¿çœ‹èµ·ä¾†åƒæ˜¯åœ¨æä¾›å¯†ç¢¼çš„ç·šç´¢ï¼Ÿ</p>
            `;

            renderInput("è«‹è¼¸å…¥ä½ ç™¼ç¾çš„ç·šç´¢åç¨± (ä¾‹å¦‚ï¼šç´™æ¢ã€ä¾¿ç±¤)", "ç¢ºèªç·šç´¢", checkClue, 'clue-input');
        }

        /** æª¢æŸ¥ç·šç´¢æ˜¯å¦æ­£ç¢º */
        function checkClue(input) {
            const normalizedInput = input.trim().replace(/\s/g, '').toLowerCase();
            
            if (normalizedInput === CORRECT_CLUE.toLowerCase()) {
                showMessage("ç·šç´¢ç¢ºèªï¼é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„ï¼", false);
                setTimeout(() => {
                    window.scrollTo(0, 0); 
                    goToCodeEntry();
                }, 1500);
            } else {
                let hintMessage = "é€™å€‹ä¸æ˜¯æˆ‘å€‘è¦æ‰¾çš„ã€‚å†é è¿‘é‡‘åº«ä¸€é»ï¼Œé™„è¿‘æœ‰æ²’æœ‰æ¯”è¼ƒç‰¹åˆ¥çš„æ±è¥¿ï¼Ÿ";
                
                if (input.includes("è¦å‰‡") || input.includes("å®ˆå‰‡")) {
                    hintMessage = "å¾ˆæ¥è¿‘äº†ï¼ä¸æ˜¯ä¸€èˆ¬çš„è¦å‰‡ï¼Œæ˜¯è·Ÿã€é‡‘åº«ã€æœ‰é—œçš„è¦å®šï¼Œè©¦è©¦çœ‹å®Œæ•´çš„åç¨±ï¼";
                }
                
                showMessage(hintMessage, true);
            }
        }

        /** éšæ®µ 3: è¼¸å…¥å¯†ç¢¼ */
        function goToCodeEntry() {
            currentState = GAME_STATE.CODE_ENTRY;
            clearScreen();
            window.scrollTo(0, 0); 

            contentDiv.innerHTML = `
                <p>å¾ˆå¥½ï¼Œä½ å·²ç¶“æŒæ¡äº†é—œéµç·šç´¢ï¼š<strong>ã€é‡‘åº«å®ˆå‰‡ã€‘</strong>ã€‚</p>
                <p>çµåˆä½ å‰›æ‰åœ¨é‡‘åº«é–ä¸Šç™¼ç¾çš„æç¤ºï¼Œç¾åœ¨æ˜¯æ™‚å€™ç ´è§£ä¸‰ä½æ•¸å¯†ç¢¼äº†ï¼</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸‰æ­¥ã€‘</strong></p>
                <p>æ ¹æ“šå®ˆå‰‡å…§å®¹å’Œæç¤ºï¼Œæ¨ç®—å‡ºä¸‰ä½å¯†ç¢¼ã€‚é‡‘åº«è£¡çš„é‡‘å¹£ç­‰ä½ ï¼</p>
            `;

            // --- æç¤ºç³»çµ±å€å¡Š ---
            const hintSection = document.createElement('div');
            hintSection.className = 'mt-6 p-4 bg-gray-700 rounded-lg shadow-inner';
            hintSection.innerHTML = `
                <h3 class="text-xl font-bold text-red-400 mb-2 flex items-center">
                    <span class="text-3xl mr-2">ğŸ’¡</span>
                    <span>3å€‹æç¤º</span>
                </h3>
                <p class="text-sm text-red-300 mb-3">æ™‚é–“æ­¸é›¶ä»å¯æ‰“é–‹é‡‘åº«ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿâ‹¯â‹¯</p>
                <div id="hint-messages" class="space-y-2">
                    <!-- æç¤ºè¨Šæ¯å°‡åœ¨æ­¤è™•å‹•æ…‹é¡¯ç¤º -->
                </div>
            `;
            
            const hintButton = document.createElement('button');
            hintButton.id = 'reveal-hint-button';
            hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            hintButton.className = 'gold-button bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg w-full mt-4';
            hintButton.onclick = revealHint;
            
            hintSection.appendChild(hintButton);
            controlsDiv.appendChild(hintSection);
            
            // --- å¯†ç¢¼è¼¸å…¥å€å¡Š ---
            const inputContainer = document.createElement('div');
            inputContainer.className = 'mt-6 pt-6 border-t border-gray-600';

            const input = document.createElement('input');
            input.id = 'code-input';
            input.type = 'number';
            input.maxLength = 3;
            input.placeholder = "æ¯è¼¸éŒ¯ä¸€æ¬¡æ‰£é™¤30ç§’";
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400 w-full';
            
            const button = document.createElement('button');
            button.textContent = "è§£é–é‡‘åº«ï¼";
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full mt-3';
            button.onclick = () => checkCode(document.getElementById('code-input').value);

            input.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    checkCode(document.getElementById('code-input').value);
                }
            });

            inputContainer.appendChild(input);
            inputContainer.appendChild(button);
            controlsDiv.appendChild(inputContainer);
        }

        /** æª¢æŸ¥å¯†ç¢¼æ˜¯å¦æ­£ç¢º */
        function checkCode(input) {
            const normalizedInput = input.trim();
            
            if (normalizedInput === CORRECT_CODE) {
                showMessage("å¯†ç¢¼æ­£ç¢ºï¼é‡‘åº«é–æ­£åœ¨è§£é–‹...", false);
                
                // è¨ˆç®—é€šé—œæ™‚é–“ (ç§’)
                completionTime = Math.floor((Date.now() - missionStartTime) / 1000); 

                if (timeLeft <= 0) {
                    setTimeout(goToLateSuccess, 2000); 
                } else {
                    setTimeout(goToSuccess, 2000); 
                }
            } else {
                // *** å¯†ç¢¼éŒ¯èª¤æ™‚æ‰£é™¤ 30 ç§’ ***
                const timeDeduction = 30;
                
                if (timeLeft - timeDeduction <= 0) {
                    timeLeft = 0; 
                    stopTimer(); // ç¢ºä¿è¨ˆæ™‚å™¨å·²åœæ­¢
                    showMessage(`å¯†ç¢¼éŒ¯èª¤ï¼é–å®šæ©Ÿåˆ¶æ­£åœ¨å•Ÿå‹•... æ™‚é–“å·²ç”¨ç›¡ï¼`, true);
                    updateTimer();
                } else {
                    timeLeft -= timeDeduction;
                    showMessage(`å¯†ç¢¼éŒ¯èª¤ï¼é–å®šæ©Ÿåˆ¶æ­£åœ¨å•Ÿå‹•... å°å¿ƒè¬¹æ…ï¼ä¸ç„¶è­¦å ±å°±è¦éŸ¿äº†ï¼`, true);
                    updateTimer(); // æ›´æ–°è¨ˆæ™‚å™¨é¡¯ç¤º
                }
            }
        }

        /** éšæ®µ 4a: æ­£å¸¸æˆåŠŸç•«é¢ (æ™‚é–“å…§å®Œæˆ) */
        function goToSuccess() {
            currentState = GAME_STATE.SUCCESS;
            
            // åœæ­¢ BGM ä¸¦æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            bgm.pause();
            successSound.play().catch(error => console.log("Success sound playback failed:", error));

            stopTimer();
            timerDisplay.classList.add('hidden');
            clearScreen();
            window.scrollTo(0, 0);
            
            document.body.className = 'min-h-screen flex items-center justify-center p-4 success-bg';
            container.className = 'bg-yellow-100 text-gray-900 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-yellow-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-700 mt-4 animate-bounce">
                        ä½ æˆåŠŸæ‰“é–‹é‡‘åº«ï¼
                    </h2>
                    <p class="mt-6 text-xl">
                        é‡‘å±±éŠ€å±±å°±åœ¨çœ¼å‰ï¼Œä½ å¾—æ‰‹äº†ï¼
                    </p>
                    <p class="mt-4 text-2xl font-bold p-3 bg-yellow-300 rounded-lg">
                        <strong>è«‹åˆ°ç°½åˆ°è™•å‡ºç¤ºé€™å€‹ç•«é¢é ˜å–ä½ çš„é‡‘å¹£ï¼</strong>
                    </p>
                </div>
                <div id="leaderboard-area" class="mt-6 text-white">
                    <!-- æ’è¡Œæ¦œå°‡åœ¨æ­¤è™•è¼‰å…¥ -->
                    <div class="text-center text-gray-500">è¼‰å…¥ä»Šæ—¥æ’è¡Œæ¦œä¸­...</div>
                </div>
            `;
            
            // é¡¯ç¤ºä½¿ç”¨è€… ID ä¾›å·¥ä½œäººå“¡æŸ¥è©¢
            controlsDiv.innerHTML = `<p class="text-sm text-gray-700 mt-4 text-center">ä½ çš„ä½¿ç”¨è€… ID (ä¾›æŸ¥è©¢): <span class="font-mono text-xs break-all">${userId}</span></p>`;
            
            // *** å„²å­˜åˆ†æ•¸ä¸¦é¡¯ç¤ºæ’å ***
            saveScore();
        }

        /** éšæ®µ 4b: é²ä¾†æˆåŠŸç•«é¢ (æ™‚é–“æ­¸é›¶å¾Œæ‰å®Œæˆ) */
        function goToLateSuccess() {
            currentState = GAME_STATE.SUCCESS; // ä»è¦–ç‚ºæˆåŠŸç‹€æ…‹

            // åœæ­¢ BGM ä¸¦æ’­æ”¾é²ä¾†éŸ³æ•ˆ
            bgm.pause();
            lateSound.play().catch(error => console.log("Late sound playback failed:", error));
            
            stopTimer();
            timerDisplay.classList.add('hidden'); 
            clearScreen();
            window.scrollTo(0, 0);
            
            document.body.className = 'min-h-screen flex items-center justify-center p-4 success-bg';
            container.className = 'bg-yellow-100 text-gray-900 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-yellow-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-700 mt-4 animate-bounce">
                        ä½ æˆåŠŸæ‰“é–‹é‡‘åº«ï¼
                    </h2>
                    <p class="mt-6 text-xl">
                        ä½†æ˜¯æ²’æƒ³åˆ°ä½ ä¾†çš„å¤ªæ™šäº†ï¼Œåªå‰©ä¸‹â‹¯â‹¯
                    </p>
                    <p class="mt-4 text-2xl font-bold p-3 bg-yellow-300 rounded-lg">
                        <strong>è«‹åˆ°ç°½åˆ°è™•å‡ºç¤ºé€™å€‹ç•«é¢é ˜å–ä½ çš„çå‹µï¼</strong>
                    </p>
                </div>
                <div id="leaderboard-area" class="mt-6 text-white">
                    <!-- æ’è¡Œæ¦œå°‡åœ¨æ­¤è™•è¼‰å…¥ -->
                    <div class="text-center text-gray-500">è¼‰å…¥ä»Šæ—¥æ’è¡Œæ¦œä¸­...</div>
                </div>
            `;
            
            // é¡¯ç¤ºä½¿ç”¨è€… ID ä¾›å·¥ä½œäººå“¡æŸ¥è©¢
            controlsDiv.innerHTML = `<p class="text-sm text-gray-700 mt-4 text-center">ä½ çš„ä½¿ç”¨è€… ID (ä¾›æŸ¥è©¢): <span class="font-mono text-xs break-all">${userId}</span></p>`;
            
            // *** å„²å­˜åˆ†æ•¸ä¸¦é¡¯ç¤ºæ’å ***
            saveScore();
        }


        /** éšæ®µ 5: å¤±æ•—ç•«é¢ */
        function gameOver() {
            currentState = GAME_STATE.FAIL;
            clearScreen();
            stopTimer();
            window.scrollTo(0, 0); // è‡ªå‹•æ²å‹•åˆ°æœ€ä¸Šé¢
            
            container.className = 'bg-red-900 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-red-700';
            
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-red-400 mt-4">
                        è¡Œå‹•å¤±æ•—ï¼
                    </h2>
                    <p class="mt-6 text-xl">
                        æ›ç­çš„ä¿é¢å·²ç¶“åˆ°é”ï¼Œä½ è¢«æŠ“å€‹æ­£è‘—ã€‚é‡‘å¹£å¤¢ç¢ï¼
                    </p>
                    <p class="mt-4">
                        ä¸‹æ¬¡æº–å‚™æ›´å……åˆ†å†ä¾†å§ã€‚
                    </p>
                </div>
            `;
            renderButton("é‡æ–°é–‹å§‹", goToInitialImageScreen); // é‡æ–°å›åˆ°å°é¢é 
        }

        // --- å•Ÿå‹•éŠæˆ²ï¼šç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆ ---
        async function mainGameLoad() {
            console.log("Starting Firebase initialization...");
            // é¡¯ç¤ºè¼‰å…¥ç•«é¢
            loadingScreen.style.display = 'flex'; 
            await initializeFirebase(); // ç­‰å¾… Firebase åˆå§‹åŒ–å®Œæˆ
            
            // æª¢æŸ¥æ˜¯å¦æˆåŠŸåˆå§‹åŒ– (å¦‚æœå¤±æ•—ï¼ŒshowFatalError å·²ç¶“è¢«å‘¼å«ï¼Œæœƒé¡¯ç¤ºéŒ¯èª¤æ–¹å¡Š)
            if (!isFirebaseInitialized) {
                console.log("Firebase failed to initialize. Halting game start.");
                return;
            }

            console.log("Firebase ready. Starting game flow.");
            goToInitialImageScreen(); // å•Ÿå‹•éŠæˆ²æµç¨‹
        }

        window.onload = mainGameLoad;

    </script>
</body>
</html>
