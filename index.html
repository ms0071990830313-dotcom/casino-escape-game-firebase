<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›²</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Inter å’Œ Noto Sans TC ç¢ºä¿ä¸­è‹±æ–‡å­—é«”ç¾è§€ */
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯, ç¬¦åˆé»‘å¹«ä¸»é¡Œ */
        }
        .text-shadow-custom {
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5), 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .gold-button {
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            font-weight: 700;
        }
        .gold-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        .gold-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        /* æˆåŠŸç•«é¢ç‰¹æ•ˆ */
        .success-bg {
            background: radial-gradient(circle at center, #ffeb3b 0%, #ffc107 70%, #ff9800 100%);
            animation: pulse-gold 1.5s infinite alternate;
        }
        @keyframes pulse-gold {
            from { filter: brightness(1.0); }
            to { filter: brightness(1.1); }
        }
        /* æ™‚é–“å¿«åˆ°æ™‚çš„é–ƒçˆæ•ˆæœ */
        .timer-warning {
            animation: flash-red 0.5s infinite alternate;
        }
        @keyframes flash-red {
            from { background-color: #8b0000; }
            to { background-color: #dc2626; }
        }
        /* æ–°å¢ï¼šå€’æ•¸å‰©ä¸‹ 2 åˆ†é˜æ™‚çš„æ”¾å¤§æ•ˆæœ */
        .timer-large {
            font-size: 1.5rem; /* è®Šå¤§ */
            padding: 0.75rem; /* å¢åŠ å…§é‚Šè· */
            border: 3px solid #ffeb3b; /* å¢åŠ é‚Šæ¡†å¼·èª¿ */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            transition: all 0.3s ease-in-out;
        }
        /* æ•˜äº‹æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
        .fade-transition {
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        .fade-in {
            opacity: 1;
        }
        .fade-out {
            opacity: 0;
        }
        /* è€å¤§é¸æ“‡ä»‹é¢æ¨£å¼ */
        .boss-item {
            aspect-ratio: 1 / 1;
        }
        .boss-check {
            opacity: 0;
            transition: opacity 0.2s;
        }
        /* æ’è¡Œæ¦œè¡¨æ ¼æ¨£å¼ */
        .leaderboard-table {
            border-collapse: separate;
            border-spacing: 0 5px; /* å¢åŠ è¡Œé–“è· */
        }
        .leaderboard-table td {
            padding: 8px;
        }
    </style>
    
    <!-- å¼•å…¥ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. æ‚¨çš„ Firebase å°ˆæ¡ˆè¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyCR-oc58h8fmdqt-7VU1F9hstznu0l0vvQ",
            authDomain: "casini-game.firebaseapp.com",
            projectId: "casini-game",
            storageBucket: "casini-game.firebasestorage.app",
            messagingSenderId: "615777698848",
            appId: "1:615777698848:web:a6ec9b8eb872168d86a845"
        };
        
        // --- 2. åˆå§‹åŒ–ä¸¦å®šç¾©å…¨åŸŸè®Šæ•¸ ---
        window.firebaseApp = initializeApp(firebaseConfig);
        window.db = getFirestore(window.firebaseApp);
        window.auth = getAuth(window.firebaseApp);
        // è¨­å®š App ID ä½œç‚ºè³‡æ–™åº«è·¯å¾‘çš„ä¸€éƒ¨åˆ† (é€™è£¡ä½¿ç”¨ projectId)
        window.APP_ID = firebaseConfig.projectId;
        window.currentUserId = null;
        window.isAuthReady = false;

        // è¨­ç½®æ—¥èªŒç´šåˆ¥ï¼Œå¹«åŠ©èª¿è©¦
        setLogLevel('error');
        
        // --- 3. ç›£è½èªè­‰ç‹€æ…‹ä¸¦æº–å‚™åˆå§‹åŒ–éŠæˆ² ---
        onAuthStateChanged(window.auth, (user) => {
            if (user) {
                window.currentUserId = user.uid;
                console.log("Firebase: åŒ¿åç™»å…¥æˆåŠŸ. User ID:", user.uid);
            } else {
                window.currentUserId = null; 
                console.log("Firebase: èªè­‰å¤±æ•—æˆ–ç­‰å¾…ä¸­.");
            }
            window.isAuthReady = true;
        });
        
        // å°‡å¿…è¦çš„ Firebase å‡½æ•¸æš´éœ²çµ¦ä¸»è…³æœ¬
        window.fs = { collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, Timestamp, signInAnonymously };

    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- èƒŒæ™¯éŸ³æ¨‚ -->
    <audio id="bgm" loop>
        <source src="Mission Impossible Theme (Full Theme).mp3" type="audio/mp3">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒéŸ³é »æ’­æ”¾ã€‚
    </audio>

    <!-- æˆåŠŸéŸ³æ•ˆ -->
    <audio id="success-sound">
        <source src="SUCCESS_Sound.mp4" type="audio/mp4">
    </audio>
    <!-- é²ä¾†æˆåŠŸéŸ³æ•ˆ -->
    <audio id="late-sound">
        <source src="LATE_sound.mp4" type="audio/mp4">
    </audio>

    <!-- ä¸»éŠæˆ²å®¹å™¨ -->
    <div id="game-container" class="bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500">
        
        <!-- æ¨™é¡Œ -->
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 text-yellow-400 text-shadow-custom">
            é»‘è‰²è¿½ç·ä»¤ï¼šè³­å ´é¢¨é›²
        </h1>

        <!-- è¨ˆæ™‚å™¨é¡¯ç¤ºå€å¡Š -->
        <div id="timer-display" class="text-center text-xl font-mono p-2 mb-4 rounded-lg bg-red-800 text-yellow-300 shadow-inner hidden">
            <!-- å‰©é¤˜æ™‚é–“: 10:00 -->
        </div>

        <!-- å…§å®¹å€å¡Š -->
        <div id="game-content" class="text-lg space-y-4">
            <!-- éŠæˆ²å…§å®¹å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- äº’å‹•å€å¡Š -->
        <div id="game-controls" class="mt-8 flex flex-col space-y-4">
            <!-- æŒ‰éˆ•å’Œè¼¸å…¥æ¡†å°‡åœ¨æ­¤è™•å‹•æ…‹è¼‰å…¥ -->
        </div>

        <!-- è¨Šæ¯å€å¡Š (ç”¨æ–¼æç¤ºéŒ¯èª¤æˆ–æˆåŠŸ) -->
        <div id="message-area" class="mt-4 p-3 rounded-lg text-center font-bold hidden"></div>

    </div>

    <script type="text/javascript">
        // --- Firebase å…¨åŸŸè®Šæ•¸å®šç¾© ---
        let db = null;
        let auth = null;
        let APP_ID = null;
        let fs = null;
        
        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† ---
        const GAME_STATE = {
            START: 0,       // éŠæˆ²é–‹å§‹æ•˜äº‹ç•«é¢
            VAULT_LOCATE: 1, // ç¢ºèªé‡‘åº«ä½æ•¸
            CLUE_HUNT: 2,    // å°‹æ‰¾é‡‘åº«å®ˆå‰‡
            CODE_ENTRY: 3,   // è¼¸å…¥å¯†ç¢¼
            SUCCESS: 4,      // æˆåŠŸ
            FAIL: 5          // å¤±æ•—
        };

        const CORRECT_CLUE = "é‡‘åº«å®ˆå‰‡";
        const CORRECT_CODE = "275"; 
        
        // è¨ˆæ™‚å™¨è¨­å®š (10 åˆ†é˜ = 600 ç§’)
        const INITIAL_TIME_SECONDS = 600;
        let timerInterval = null;
        let timeLeft = INITIAL_TIME_SECONDS;

        let currentState = GAME_STATE.START;
        
        // *** å…¨åŸŸè®Šæ•¸ï¼šç©å®¶åç¨±ã€è€å¤§é¸æ“‡ã€æ™‚é–“è¨˜éŒ„ ***
        let playerName = "";
        let selectedBossId = null; 
        let missionStartTime = 0; // ä»»å‹™é–‹å§‹æ™‚é–“ (Date.now())
        let completionTime = 0;   // æœ€çµ‚é€šé—œæ™‚é–“ (ç§’)

        // å¯†ç¢¼æç¤ºç›¸é—œ
        let hintsRevealed = 0; 
        
        // *** DOM å…ƒç´ å®£å‘Š ***
        let container, contentDiv, controlsDiv, messageArea, timerDisplay, bgm, successSound, lateSound;

        // *** å°è©±å…§å®¹ (ç”±è€å¤§æ•˜äº‹) ***
        let currentDialogueStep = 0; 
        const DIALOGUE_STEPS = (name) => [
            { speaker: 'BOSS', text: `<span class="text-red-400">${name}</span>ä½ ä¾†å•¦â‹¯â‹¯`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'PLAYER', text: `è€å¤§ï¼æœ‰ä½•å©å’ï¼Ÿ`, buttonText: "ç¹¼çºŒ" },
            { speaker: 'BOSS', text: `ä½ è¢«é‚€è«‹åˆ°é€™å ´ç”±é»‘å¹«èˆ‰è¾¦çš„è³­å ´å®´æœƒï¼Œè¡¨é¢ä¸Šæ˜¯ä¾†ä¸€æ“²åƒé‡‘çš„å®¢äººï¼Œä½†ä½ çœŸæ­£çš„ç›®æ¨™æ˜¯è³­å ´å¾Œé¢çš„é‚£åº§<span class="text-yellow-500 font-bold">é‡‘åº«</span>ï¼`, buttonText: "ç¹¼çºŒ" },
            { 
                speaker: 'BOSS', 
                text: `ä»Šå¤©å¾ˆå¤šå…¶ä»–é»‘å¹«æˆå“¡ä¹Ÿæ˜¯æ‰“è‘—è·Ÿä½ ä¸€æ¨£çš„ä¸»æ„ï¼Œä½ å¿…é ˆçˆ­åˆ†å¥ªç§’ï¼Œç›¡å¿«æŠŠé‡‘åº«æ‰“é–‹ï¼Œ<span class="text-yellow-400 font-bold">ä¸ç„¶è£¡é¢çš„é‡‘å¹£æœƒè¢«å…¶ä»–äººæ·è¶³å…ˆç™»ï¼</span>`, 
                buttonText: "ç¹¼çºŒ" 
            },
            {
                speaker: 'BOSS',
                text: `ç¾åœ¨ï¼Œä½ è¶ä¿é¢åœ¨æ‰“çŒç¡ï¼Œå·²ç¶“å·å·æ½›å…¥åˆ°äº†è³­å ´çš„é‡‘åº«ä½ç½®ã€‚<br>å™“ï¼å°å¿ƒä¸è¦è¢«ç™¼ç¾ï¼<br><span class="text-yellow-400 font-bold">ååˆ†é˜å…§</span>ä½ å¿…é ˆè§£å‡ºé€™å€‹è¬é¡Œï¼Œä¸ç„¶æ›ç­çš„äººå°±è¦ä¾†äº†ï¼Œä½ æœƒè¢«æŠ“å€‹æ­£è‘—ï¼<br>ä»”ç´°æŸ¥çœ‹é‡‘åº«åœ¨å“ªè£¡ï¼Ÿé‚„æœ‰å¯†ç¢¼ï¼Œä½ éœ€è¦çŸ¥é“å¯†ç¢¼æ˜¯å¹¾ä½æ•¸.`,
                buttonText: "å·å·æ½›å…¥é‡‘åº«",
                action: 'START_MISSION'
            }
        ];

        // --- éŠæˆ²åˆå§‹åŒ–å…¥å£ ---
        function initGame() {
            container = document.getElementById('game-container');
            contentDiv = document.getElementById('game-content');
            controlsDiv = document.getElementById('game-controls');
            messageArea = document.getElementById('message-area');
            timerDisplay = document.getElementById('timer-display');
            bgm = document.getElementById('bgm');
            successSound = document.getElementById('success-sound');
            lateSound = document.getElementById('late-sound');
            
            // å¾ Window ç¯„åœç²å– Firebase å¯¦ä¾‹
            db = window.db;
            auth = window.auth;
            APP_ID = window.APP_ID;
            fs = window.fs;

            // ç¢ºä¿ Firebase è®Šæ•¸å·²æˆåŠŸåˆå§‹åŒ–
            if (!db || !auth || !APP_ID || !fs) {
                console.error("Firebase SDK è¼‰å…¥å¤±æ•—æˆ–åˆå§‹åŒ–æœªå®Œæˆ.");
                goToInitialImageScreen();
                return;
            }
            
            goToInitialImageScreen();
        }
        
        // --- éŸ³æ¨‚/è¨ˆæ™‚å™¨/è¼”åŠ©å‡½æ•¸ ---
        function startBGM() {
            if (bgm && bgm.paused) {
                bgm.volume = 0.5;
                bgm.play().catch(error => {
                    console.log("BGM è‡ªå‹•æ’­æ”¾å¤±æ•—ã€‚", error);
                });
            }
        }
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }
        function updateTimer() {
            if (timeLeft < 0) {
                timeLeft = 0;
            }
            timerDisplay.textContent = `å‰©é¤˜æ™‚é–“: ${formatTime(timeLeft)}`;

            if (timeLeft <= 120 && timeLeft > 0) {
                timerDisplay.classList.add('timer-large');
            } else {
                timerDisplay.classList.remove('timer-large');
            }

            if (timeLeft <= 60 && timeLeft > 0) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.remove('timer-warning');
            }

            if (timeLeft <= 0) {
                stopTimer();
                timerDisplay.textContent = "æ™‚é–“åˆ°ï¼æ›ç­ä¿é¢å·²åˆ°ï¼Œè«‹å¿«é€Ÿå®Œæˆå¯†ç¢¼è¼¸å…¥ã€‚";
                return;
            }
            timeLeft--;
        }
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = INITIAL_TIME_SECONDS;
            timerDisplay.classList.remove('hidden');
            updateTimer(); 
            timerInterval = setInterval(updateTimer, 1000);
        }
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        function showMessage(text, isError = false) {
            messageArea.textContent = text;
            messageArea.className = `mt-4 p-3 rounded-lg text-center font-bold ${isError ? 'bg-red-700' : 'bg-green-700'}`;
            messageArea.classList.remove('hidden');
            setTimeout(() => {
                messageArea.classList.add('hidden');
            }, 3500);
        }
        function clearScreen() {
            contentDiv.innerHTML = '';
            controlsDiv.innerHTML = '';
        }
        function renderButton(text, onClick, isFinalStep = false, id = null) {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full';
            button.onclick = onClick;
            if (id) button.id = id;
            controlsDiv.appendChild(button);
        }
        function renderInput(placeholder, buttonText, onSubmit, inputId, maxLength) {
            const constContainer = document.createElement('div');
            constContainer.className = 'flex flex-col space-y-3';
            
            const input = document.createElement('input');
            input.id = inputId;
            input.type = 'text';
            input.maxLength = maxLength || 50;
            input.placeholder = placeholder;
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400';
            
            const button = document.createElement('button');
            button.textContent = buttonText;
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg';
            button.onclick = () => onSubmit(document.getElementById(inputId).value);

            input.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    onSubmit(document.getElementById(inputId).value);
                }
            });

            constContainer.appendChild(input);
            constContainer.appendChild(button);
            controlsDiv.appendChild(constContainer);
        }
        function revealHint() {
            const HINTS = [
                "æç¤º 1: çœ‹çœ‹å®ˆå‰‡ç¬¬ä¸€æ¢ï¼Œæ¨™é¡Œçš„é¡è‰²æ˜¯å¦è—è‘—æ•¸å­—ï¼Ÿ",
                "æç¤º 2: å®ˆå‰‡æåˆ°æ–¹å‘ï¼šä¸Šã€ä¸‹ã€å·¦ã€å³ï¼Œåˆ†åˆ¥å°æ‡‰åˆ»åº¦ä½ç½®ã€‚",
                "æç¤º 3: å°‡æ‰€æœ‰ç™¼ç¾çš„æ•¸å­—ï¼Œä¾ç…§å®ˆå‰‡æœ«å°¾çš„å­—æ¯é †åºæ’åˆ—ã€‚"
            ];
            if (hintsRevealed >= HINTS.length) {
                showMessage("å·²ç¶“æ²’æœ‰æ›´å¤šæç¤ºäº†ï¼", true);
                return;
            }
            const timeDeduction = 60;
            if (timeLeft - timeDeduction <= 0) {
                timeLeft = 0; 
                showMessage("æ™‚é–“ç”¨ç›¡ï¼ä½ ç„¡æ³•å†ç²å–æç¤ºäº†ã€‚", true);
                updateTimer();
            } else {
                timeLeft -= timeDeduction;
                showMessage(`æ‰£é™¤ ${timeDeduction} ç§’ã€‚è«‹åƒè€ƒæ–°æç¤ºã€‚`, false);
                updateTimer();
            }
            
            const hintText = HINTS[hintsRevealed];
            const hintDiv = document.getElementById('hint-messages');
            
            const p = document.createElement('p');
            p.className = "mt-2 p-3 bg-gray-700 rounded-lg border border-red-500 transition-all duration-300 transform scale-100 hover:scale-[1.02]";
            p.innerHTML = `<span class="text-red-400 font-bold">[æç¤º #${hintsRevealed + 1} (-60ç§’)]</span>: ${hintText}`;
            hintDiv.appendChild(p);
            hintsRevealed++;
            
            const hintButton = document.getElementById('reveal-hint-button');
            if (hintsRevealed >= HINTS.length) {
                hintButton.textContent = "å·²ç„¡æ›´å¤šæç¤º";
                hintButton.disabled = true;
                hintButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                hintButton.classList.add('bg-gray-500', 'cursor-not-allowed');
            } else {
                hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šç´€éŒ„é€šé—œæ™‚é–“èˆ‡æ’åè¨ˆç®— ---

        function getPublicRanksCollectionRef() {
            if (!db || !APP_ID) return null;
            return fs.collection(db, `artifacts/${APP_ID}/public/data/puzzle_ranks`);
        }

        async function recordCompletionAndShowRank(isLate) {
            const uid = window.currentUserId;
            if (!db || !uid) {
                console.error("ç„¡æ³•å¯«å…¥ç´€éŒ„ï¼šFirebase æˆ– User ID å°šæœªæº–å‚™å¥½ã€‚");
                return { rank: 'N/A', totalRecords: 'N/A', topTenRanks: [] };
            }

            const ranksRef = getPublicRanksCollectionRef();
            if (!ranksRef) return { rank: 'N/A', totalRecords: 'N/A', topTenRanks: [] };

            const newRecord = {
                name: playerName,
                userId: uid,
                completionTime: completionTime,
                timestamp: fs.serverTimestamp(), 
                isLate: isLate,
                bossId: selectedBossId
            };
            
            let docRef;
            try {
                docRef = await fs.addDoc(ranksRef, newRecord);
            } catch (e) {
                console.error("Error adding document:", e);
                return { rank: 'Error', totalRecords: 'Error', topTenRanks: [] };
            }

            try {
                const todayStart = new Date();
                todayStart.setHours(0, 0, 0, 0); 
                const q = fs.query(ranksRef);
                const querySnapshot = await fs.getDocs(q);
                
                const allTodayDocs = querySnapshot.docs
                    .map(d => ({ id: d.id, ...d.data() }))
                    .filter(d => d.timestamp && d.timestamp.toDate() >= todayStart);

                const sortedByEntry = [...allTodayDocs].sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp ? b.timestamp.seconds : 0;
                    return timeA - timeB;
                });
                
                const rank = sortedByEntry.findIndex(d => d.id === docRef.id) + 1;
                const totalRecords = allTodayDocs.length;

                const topTenRanks = [...allTodayDocs]
                    .sort((a, b) => a.completionTime - b.completionTime)
                    .slice(0, 10)
                    .map((data, index) => {
                        const minutes = Math.floor(data.completionTime / 60);
                        const seconds = data.completionTime % 60;
                        return {
                            rank: index + 1,
                            name: data.name,
                            time: `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`,
                            isPlayer: data.userId === uid
                        };
                    });

                return { rank, totalRecords, topTenRanks };

            } catch (e) {
                console.error("Error processing ranks:", e);
                return { rank: 'Error', totalRecords: 'Error', topTenRanks: [] };
            }
        }

        function renderLeaderboard(ranks) {
            let tableRows = ranks.map(rank => `
                <tr class="${rank.isPlayer ? 'bg-yellow-400 text-gray-900 font-extrabold shadow-md' : 'bg-gray-700 text-gray-200'} transition hover:bg-yellow-200">
                    <td class="p-2 text-center rounded-l-lg">${rank.rank}</td>
                    <td class="p-2 font-semibold">${rank.name}</td>
                    <td class="p-2 text-right rounded-r-lg font-mono">${rank.time}</td>
                </tr>
            `).join('');

            return `
                <div class="mt-8 pt-4 border-t border-yellow-600">
                    <h3 class="text-2xl font-bold text-yellow-500 mb-4 text-center">ä»Šæ—¥æœ€é€Ÿé»‘å¹« (Top 10)</h3>
                    <div class="w-full max-w-sm mx-auto">
                        <table class="leaderboard-table w-full text-sm">
                            <thead>
                                <tr class="text-gray-400 bg-gray-800">
                                    <th class="p-1 w-1/6 text-center">æ’å</th>
                                    <th class="p-1 w-3/6 text-left">åŒ–å</th>
                                    <th class="p-1 w-2/6 text-right">è€—æ™‚ (MM:SS)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows.length > 0 ? tableRows : '<tr><td colspan="3" class="text-center p-4 text-gray-500 bg-gray-700 rounded-lg">ç›®å‰æ²’æœ‰ç´€éŒ„ã€‚</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function displayNextDialogue() {
            const dialogueData = DIALOGUE_STEPS(playerName);
            if (currentDialogueStep >= dialogueData.length) {
                goToVaultLocate();
                return;
            }
            const step = dialogueData[currentDialogueStep];
            const currentContent = document.getElementById('dialogue-wrapper');
            if (currentContent) {
                currentContent.classList.remove('fade-in');
                currentContent.classList.add('fade-out');
            }
            setTimeout(() => {
                controlsDiv.innerHTML = '';
                let wrapper = document.getElementById('dialogue-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.id = 'dialogue-wrapper';
                    contentDiv.appendChild(wrapper);
                }
                wrapper.className = 'fade-transition space-y-4'; 
                const speakerClass = step.speaker === 'BOSS' ? 'text-yellow-400 font-bold' : 'text-green-400 font-bold';
                const speakerName = step.speaker === 'PLAYER' ? playerName : 'è€å¤§';
                wrapper.innerHTML = `
                    <div class="p-4 bg-gray-700 rounded-lg shadow-inner">
                        <p class="${speakerClass} mb-2">${speakerName}:</p>
                        <p class="text-gray-200">${step.text}</p>
                    </div>
                `;
                wrapper.classList.remove('fade-out');
                wrapper.classList.add('fade-in');
                const buttonAction = () => {
                    if (step.action === 'START_MISSION') {
                        missionStartTime = Date.now(); 
                        startTimer(); 
                        goToVaultLocate(); 
                    } else {
                        currentDialogueStep++;
                        displayNextDialogue();
                    }
                };
                renderButton(step.buttonText, buttonAction);
                window.scrollTo(0, 0); 
            }, 1000); 
        }

        function goToInitialImageScreen() {
            clearScreen();
            stopTimer(); 
            timerDisplay.classList.add('hidden');
            document.body.className = 'min-h-screen flex items-center justify-center p-4 bg-gray-900';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';
            contentDiv.innerHTML = `
                <div class="text-center space-y-6">
                    <p class="text-lg text-gray-300">ä¸€å ´ç§˜å¯†è¡Œå‹•å³å°‡å±•é–‹...</p>
                    <img src="cover.jpg" 
                         onerror="this.onerror=null; this.src='https://placehold.co/400x200/29294F/FFF?text=èµ·å§‹ç•«é¢åœ–ç‰‡';"
                         alt="èµ·å§‹ç•«é¢åœ–ç‰‡" 
                         class="mx-auto w-full max-w-sm rounded-lg shadow-xl border-2 border-yellow-500 object-cover"
                    >
                </div>
            `;
            const checkboxArea = document.createElement('div');
            checkboxArea.className = 'mt-6 space-y-3 text-left text-gray-200';
            checkboxArea.innerHTML = `
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-network" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹ç¢ºä¿ç¶²è·¯ç©©å®š</span>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer">
                    <input type="checkbox" id="check-volume" class="form-checkbox h-5 w-5 text-yellow-500 bg-gray-700 border-gray-500 rounded focus:ring-0">
                    <span>è«‹æ‰“é–‹éŠæˆ²éŸ³é‡</span>
                </label>
            `;
            controlsDiv.appendChild(checkboxArea);
            const initialButton = document.createElement('button');
            initialButton.id = 'initial-start-button';
            initialButton.textContent = "é€²å…¥ç§˜å¯†ä»»å‹™";
            initialButton.disabled = true; 
            initialButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            controlsDiv.appendChild(initialButton);
            function checkPreconditions() {
                const networkChecked = document.getElementById('check-network').checked;
                const volumeChecked = document.getElementById('check-volume').checked;
                const isReady = networkChecked && volumeChecked;
                initialButton.disabled = !isReady;
                if (isReady) {
                    initialButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    messageArea.classList.add('hidden');
                } else {
                    initialButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                    initialButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                }
            }
            document.getElementById('check-network').addEventListener('change', checkPreconditions);
            document.getElementById('check-volume').addEventListener('change', checkPreconditions);
            initialButton.onclick = () => {
                if (!initialButton.disabled) {
                    if (window.auth && !window.auth.currentUser) {
                        fs.signInAnonymously(auth).catch(error => console.error(error));
                    }
                    goToBossSelection();
                } else {
                    showMessage("è«‹ç¢ºä¿ä¸Šæ–¹å…©é …çš†å·²ç¢ºèª", true);
                }
            };
        }

        function goToBossSelection() {
            clearScreen();
            window.scrollTo(0, 0);
            selectedBossId = null;
            document.body.className = 'min-h-screen flex items-center justify-center p-4';
            container.className = 'bg-gray-800 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500';
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-4">ä½ çš„è€å¤§æ˜¯ï¼Ÿ</h2>
                <p class="text-sm text-gray-400 text-center mb-6">*äººç‰©ä¸å½±éŸ¿æ•…äº‹é€²è¡Œ</p>
                <div id="boss-grid" class="grid grid-cols-3 gap-2"></div>
            `;
            const confirmButton = document.createElement('button');
            confirmButton.id = 'confirm-boss-button';
            confirmButton.textContent = "æˆ‘çš„è€å¤§æ˜¯ä»–/å¥¹"; 
            confirmButton.disabled = true; 
            confirmButton.className = 'gold-button bg-gray-500 cursor-not-allowed text-white px-6 py-3 rounded-lg w-full mt-6 transition-all duration-200';
            confirmButton.onclick = () => {
                 if (window.isAuthReady && window.currentUserId) {
                    goToNameInput();
                 } else {
                    showMessage("ä¼ºæœå™¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", true);
                 }
            };
            controlsDiv.appendChild(confirmButton);
            const bosses = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const gridDiv = document.getElementById('boss-grid');
            bosses.forEach(id => {
                const item = document.createElement('div');
                item.className = 'boss-item relative cursor-pointer border-4 border-transparent rounded-lg overflow-hidden transition-all duration-200 hover:border-yellow-500';
                item.setAttribute('data-boss-id', id);
                item.onclick = () => selectBoss(id);
                item.innerHTML = `
                    <img src="boss_${id}.png" onerror="this.onerror=null; this.src='https://placehold.co/100x100/3A3A3A/FFF?text=Boss%20${id}';" class="w-full h-full object-cover rounded-md">
                    <div id="check-${id}" class="boss-check absolute inset-0 bg-black/50 flex items-center justify-center text-4xl text-yellow-400">âœ“</div>
                `;
                gridDiv.appendChild(item);
            });
            function selectBoss(id) {
                selectedBossId = id;
                document.querySelectorAll('.boss-item').forEach(item => {
                    const itemId = parseInt(item.getAttribute('data-boss-id'));
                    const check = item.querySelector('.boss-check');
                    if (itemId === id) {
                        item.classList.add('border-yellow-400');
                        check.classList.add('opacity-100');
                    } else {
                        item.classList.remove('border-yellow-400');
                        check.classList.remove('opacity-100');
                    }
                });
                if (window.isAuthReady) {
                    confirmButton.disabled = false;
                    confirmButton.classList.remove('bg-gray-500', 'cursor-not-allowed');
                    confirmButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                } else {
                    confirmButton.disabled = true;
                    confirmButton.classList.add('bg-gray-500', 'cursor-not-allowed');
                    confirmButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    showMessage("ä¼ºæœå™¨é€£ç·šä¸­ï¼Œè«‹ç¨å€™ã€‚", false);
                }
            }
        }

        function goToNameInput() {
            clearScreen();
            window.scrollTo(0, 0);
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-400 text-center mb-6">å‘Šè¨´è€å¤§ä½ çš„ä»£è™Ÿ</h2>
                <p class="text-md text-gray-400 text-center">é€™æ˜¯ä½ ç¨ä¸€ç„¡äºŒçš„èº«ä»½ï¼Œå°‡ç”¨æ–¼ç´€éŒ„ä½ çš„é€šé—œé †åºã€‚</p>
            `;
            
            const submitName = async (name) => {
                const trimmedName = name.trim();
                if (trimmedName.length >= 2 && trimmedName.length <= 10) {
                    showMessage("æ­£åœ¨é©—è­‰ä»£è™Ÿæ˜¯å¦å¯ç”¨...", false);
                    
                    try {
                        const ranksRef = getPublicRanksCollectionRef();
                        if (!ranksRef) throw new Error("Database not ready");

                        const querySnapshot = await fs.getDocs(ranksRef);
                        const isDuplicate = querySnapshot.docs.some(doc => doc.data().name === trimmedName);

                        if (isDuplicate) {
                            showMessage("ä½ çš„ä»£è™Ÿå·²è¢«ä½¿ç”¨ï¼Œè«‹æ›´æ›ä¸€å€‹ã€‚", true);
                        } else {
                            playerName = trimmedName;
                            showMessage(`ä»£è™Ÿï¼š${playerName}ï¼Œç¢ºèªï¼`, false);
                            setTimeout(goToMissionDialogue, 1500); 
                        }
                    } catch (e) {
                        console.error("é©—è­‰å¤±æ•—:", e);
                        showMessage("é€£ç·šæª¢æŸ¥å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", true);
                    }
                } else {
                    showMessage("ä»£è™Ÿé•·åº¦éœ€åœ¨ 2 åˆ° 10 å€‹å­—å…ƒä¹‹é–“ã€‚", true);
                }
            };

            renderInput("è«‹è¼¸å…¥ä½ çš„é»‘å¹«åŒ–åï¼ˆ2-10å€‹å­—ï¼‰", "ç¢ºèªä»£è™Ÿ", submitName, 'codename-input', 10);
            document.getElementById('codename-input').focus();
        }

        function goToMissionDialogue() {
            currentState = GAME_STATE.START;
            clearScreen();
            stopTimer();
            hintsRevealed = 0;
            timerDisplay.classList.add('hidden'); 
            startBGM(); 
            contentDiv.innerHTML = `
                <div class="text-center mb-6">
                    <img src="boss_${selectedBossId}.png" onerror="this.onerror=null; this.src='https://placehold.co/120x120/3A3A3A/FFF?text=BOSS';" class="mx-auto w-32 h-32 object-cover rounded-full shadow-lg border-4 border-red-500">
                </div>
                <div id="dialogue-content-area" class="space-y-4"></div>
            `;
            const dialogueArea = document.getElementById('dialogue-content-area');
            const wrapper = document.createElement('div');
            wrapper.id = 'dialogue-wrapper';
            wrapper.className = 'fade-transition space-y-4';
            dialogueArea.appendChild(wrapper);
            currentDialogueStep = 0;
            displayNextDialogue();
        }

        function goToVaultLocate() {
            currentState = GAME_STATE.VAULT_LOCATE;
            clearScreen();
            window.scrollTo(0, 0);
            contentDiv.innerHTML = `
                <p>ä½ ç¾åœ¨å·²ç¶“æˆåŠŸæ½›å…¥è³­å ´æ”¾<span class="text-yellow-500 font-bold">é‡‘åº«</span>çš„åœ°æ–¹ï¼è¶•å¿«æ‰¾æ‰¾é‡‘åº«åœ¨å“ªè£¡ï¼Ÿ</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸€æ­¥ã€‘</strong></p>
                <p>ä»”ç´°è§€å¯Ÿç¾å¯¦ä¸–ç•Œä¸­çš„é‡‘åº«å¯¶ç®±ï¼Œ<strong>å¯†ç¢¼é–æ˜¯å¹¾ä½æ•¸ï¼Ÿ</strong></p>
            `;
            renderInput("è«‹è¼¸å…¥å¯†ç¢¼é–çš„ä½æ•¸ (æ•¸å­—)", "ç¢ºèªä½æ•¸", checkVaultDigits, 'digit-input', 1);
            document.getElementById('digit-input').type = 'number';
        }

        function checkVaultDigits(input) {
            const digitInput = parseInt(input.trim());
            if (digitInput === 3) {
                showMessage("æ•¸å­—æ­£ç¢ºï¼ä½ ç™¼ç¾äº†é‡‘åº«å¯†ç¢¼æ˜¯ä¸‰ä½æ•¸å¯†ç¢¼é–ã€‚", false);
                setTimeout(() => { window.scrollTo(0, 0); goToClueHunt(); }, 2500);
                return;
            }
            let hintMessage = "é€™å€‹ä½æ•¸ä¸æ­£ç¢ºã€‚";
            if (isNaN(digitInput) || digitInput === 0) hintMessage = "è«‹è¼¸å…¥ä¸€å€‹æ•¸å­—ã€‚";
            else if (digitInput > 4) hintMessage = "é€™å€‹æ•¸å­—å¤ªå¤§äº†ã€‚";
            else if (digitInput === 2) hintMessage = "åªæœ‰å…©ä½æ•¸å—ï¼Ÿè«‹å†é è¿‘ä¸€é»æ•¸æ•¸çœ‹ã€‚";
            else if (digitInput === 4) hintMessage = "ä¸å°ï¼Œå®ƒä¸æ˜¯å››ä½æ•¸çš„ã€‚";
            showMessage(hintMessage, true);
        }

        function goToClueHunt() {
            currentState = GAME_STATE.CLUE_HUNT;
            clearScreen();
            window.scrollTo(0, 0);
            contentDiv.innerHTML = `
                <p>ä½ ç¢ºèªäº†ï¼Œé‡‘åº«é–éœ€è¦<strong>ä¸‰ä½æ•¸å¯†ç¢¼</strong>æ‰èƒ½æ‰“é–‹ã€‚åŒæ™‚ï¼Œä½ ç™¼ç¾<strong>é‡‘åº«ä¸Šæœ‰ä¸€å€‹æç¤º</strong>å¯«è‘—ä»€éº¼â‹¯â‹¯ã€‚</p>
                <p>é‡‘åº«å¯†ç¢¼æ¯å¤©éƒ½æœƒæ›ï¼Œä½†ä½ äº‹å‰å·²ç¶“èª¿æŸ¥éï¼Œç›¸é—œæç¤ºä¸€å®šå°±åœ¨é‡‘åº«é™„è¿‘ã€‚</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬äºŒæ­¥ã€‘</strong></p>
                <p>ç’°é¡§å››å‘¨ï¼Œå°‹æ‰¾å‘¨é‚Šç‰©å“ï¼Œä»€éº¼æ±è¥¿çœ‹èµ·ä¾†åƒæ˜¯åœ¨æä¾›å¯†ç¢¼çš„ç·šç´¢ï¼Ÿ</p>
            `;
            renderInput("è«‹è¼¸å…¥ä½ ç™¼ç¾çš„ç·šç´¢åç¨± (ä¾‹å¦‚ï¼šç´™æ¢ã€ä¾¿ç±¤)", "ç¢ºèªç·šç´¢", checkClue, 'clue-input');
        }

        function checkClue(input) {
            const normalizedInput = input.trim().replace(/\s/g, '').toLowerCase();
            if (normalizedInput === CORRECT_CLUE.toLowerCase()) {
                showMessage("ç·šç´¢ç¢ºèªï¼é€™å°±æ˜¯æˆ‘å€‘è¦æ‰¾çš„ï¼", false);
                setTimeout(() => { window.scrollTo(0, 0); goToCodeEntry(); }, 1500);
            } else {
                let hintMessage = "é€™å€‹ä¸æ˜¯æˆ‘å€‘è¦æ‰¾çš„ã€‚";
                if (input.includes("è¦å‰‡") || input.includes("å®ˆå‰‡")) hintMessage = "å¾ˆæ¥è¿‘äº†ï¼è©¦è©¦çœ‹å®Œæ•´çš„åç¨±ï¼";
                showMessage(hintMessage, true);
            }
        }

        function goToCodeEntry() {
            currentState = GAME_STATE.CODE_ENTRY;
            clearScreen();
            window.scrollTo(0, 0);
            contentDiv.innerHTML = `
                <p>å¾ˆå¥½ï¼Œä½ å·²ç¶“æŒæ¡äº†é—œéµç·šç´¢ï¼š<strong>ã€é‡‘åº«å®ˆå‰‡ã€‘</strong>ã€‚</p>
                <p>çµåˆæç¤ºï¼Œç¾åœ¨æ˜¯æ™‚å€™ç ´è§£ä¸‰ä½æ•¸å¯†ç¢¼äº†ï¼</p>
                <hr class="my-4 border-gray-600">
                <p class="text-yellow-400"><strong>ã€è¡Œå‹•æŒ‡ç¤ºï¼šç¬¬ä¸‰æ­¥ã€‘</strong></p>
                <p>æ ¹æ“šå®ˆå‰‡å…§å®¹å’Œæç¤ºï¼Œæ¨ç®—å‡ºä¸‰ä½å¯†ç¢¼ã€‚é‡‘åº«è£¡çš„é‡‘å¹£ç­‰ä½ ï¼</p>
            `;
            const hintSection = document.createElement('div');
            hintSection.className = 'mt-6 p-4 bg-gray-700 rounded-lg shadow-inner';
            hintSection.innerHTML = `
                <h3 class="text-xl font-bold text-red-400 mb-2 flex items-center"><span class="text-3xl mr-2">ğŸ’¡</span><span>3å€‹æç¤º</span></h3>
                <p class="text-sm text-red-300 mb-3">æ™‚é–“æ­¸é›¶ä»å¯æ‰“é–‹é‡‘åº«ï¼Œä½†æ˜¯å¯èƒ½æœƒç™¼ç”Ÿâ‹¯â‹¯</p>
                <div id="hint-messages" class="space-y-2"></div>
            `;
            const hintButton = document.createElement('button');
            hintButton.id = 'reveal-hint-button';
            hintButton.textContent = "æ¯å€‹æç¤ºæ‰£é™¤ 60ç§’"; 
            hintButton.className = 'gold-button bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg w-full mt-4';
            hintButton.onclick = revealHint;
            hintSection.appendChild(hintButton);
            controlsDiv.appendChild(hintSection);
            
            const inputContainer = document.createElement('div');
            inputContainer.className = 'mt-6 pt-6 border-t border-gray-600';
            const input = document.createElement('input');
            input.id = 'code-input';
            input.type = 'number';
            input.maxLength = 3;
            input.placeholder = "æ¯è¼¸éŒ¯ä¸€æ¬¡æ‰£é™¤30ç§’";
            input.className = 'p-3 rounded-lg bg-gray-700 text-white border-2 border-yellow-500 focus:outline-none focus:border-yellow-400 w-full';
            const button = document.createElement('button');
            button.textContent = "è§£é–é‡‘åº«ï¼";
            button.className = 'gold-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 px-6 py-3 rounded-lg w-full mt-3';
            button.onclick = () => checkCode(document.getElementById('code-input').value);
            inputContainer.appendChild(input);
            inputContainer.appendChild(button);
            controlsDiv.appendChild(inputContainer);
        }

        function checkCode(input) {
            const normalizedInput = input.trim();
            if (normalizedInput === CORRECT_CODE) {
                showMessage("å¯†ç¢¼æ­£ç¢ºï¼é‡‘åº«é–æ­£åœ¨è§£é–‹...", false);
                
                const penaltyTimeTaken = INITIAL_TIME_SECONDS - Math.max(0, timeLeft);
                const actualTimeElapsed = Math.floor((Date.now() - missionStartTime) / 1000);
                completionTime = Math.max(penaltyTimeTaken, actualTimeElapsed); 

                // çµ±ä¸€é€²å…¥çµç®—ç•«é¢ï¼Œç”±çµç®—é‚è¼¯æ±ºå®šé¡¯ç¤ºå“ªå¼µåœ–ç‰‡
                setTimeout(() => handleMissionComplete(), 2000);
            } else {
                timeLeft = Math.max(0, timeLeft - 30);
                if (timeLeft <= 0) { stopTimer(); showMessage(`æ™‚é–“å·²ç”¨ç›¡ï¼`, true); updateTimer(); }
                else { showMessage(`å¯†ç¢¼éŒ¯èª¤ï¼æ‰£é™¤30ç§’`, true); updateTimer(); }
            }
        }

        async function handleMissionComplete() {
            currentState = GAME_STATE.SUCCESS;
            bgm.pause();
            stopTimer();
            timerDisplay.classList.add('hidden');
            clearScreen();
            window.scrollTo(0, 0);

            contentDiv.innerHTML = `
                <div class="text-center py-10">
                    <h2 class="text-3xl font-bold text-yellow-400 mb-4">æ­£åœ¨å›å‚³æˆ°å ±ä¸¦è¨ˆç®—æ’å...</h2>
                    <p class="text-lg text-gray-400">æ­£åœ¨ç­‰å¾…ä¼ºæœå™¨ç¢ºèªæ‚¨çš„é€šé—œç´€éŒ„ã€‚</p>
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto mt-6"></div>
                </div>
            `;

            // é€™è£¡çš„ isLate åƒ…ç”¨æ–¼è¨˜éŒ„åˆ°è³‡æ–™åº«ï¼Œä¸ç›´æ¥æ±ºå®š UI
            const isLateRecord = completionTime > INITIAL_TIME_SECONDS;
            const { rank, totalRecords, topTenRanks } = await recordCompletionAndShowRank(isLateRecord);

            // --- æ ¸å¿ƒé‚è¼¯ä¿®æ­£ï¼šåˆ¤æ–·é¡¯ç¤º SUCCESS é‚„æ˜¯ LATE ---
            // æ¢ä»¶ï¼šæ’ååœ¨å‰ 50 å (å«) ä¸” çµç®—æ™‚é–“åœ¨ 600 ç§’ (å«) å…§
            const isGrandSuccess = (rank !== 'Error' && rank <= 50) && (completionTime <= INITIAL_TIME_SECONDS);

            if (isGrandSuccess) {
                successSound.play().catch(e => console.log(e));
            } else {
                lateSound.play().catch(e => console.log(e));
            }

            document.body.className = 'min-h-screen flex items-center justify-center p-4 success-bg';
            container.className = 'bg-yellow-100 text-gray-900 p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-yellow-700';

            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-yellow-700 mt-4 animate-bounce">
                        ${isGrandSuccess ? 'ä½ æˆåŠŸæ‰“é–‹é‡‘åº«ï¼' : 'è¡Œå‹•æˆåŠŸï¼Œä½†...'}
                    </h2>
                    <p class="text-xl font-bold mb-2">
                        ä»£è™Ÿ: <span class="text-red-600">${playerName}</span>
                    </p>
                    <p class="text-2xl font-extrabold mb-4 text-red-700">
                        è€—æ™‚: ${completionTime} ç§’
                    </p>
                    <p class="text-lg font-semibold mb-6 p-2 bg-yellow-200 rounded-lg shadow-md">
                        ${isGrandSuccess ? 'ğŸ‰' : 'â±ï¸'} ä»Šæ—¥ç¬¬ <span class="text-red-700 font-extrabold">${rank}</span> ä½é€šé—œç©å®¶! (å…± ${totalRecords} ç­†ç´€éŒ„)
                    </p>

                    <img src="${isGrandSuccess ? 'SUCCESS_IMAGE.png' : 'LATE_IMAGE.png'}" 
                         onerror="this.onerror=null; this.src='https://placehold.co/200x150/FFD700/000?text=${isGrandSuccess ? 'WIN' : 'LATE'}';"
                         alt="ä»»å‹™çµç®—åœ–" 
                         class="mx-auto w-1/2 max-w-sm object-contain mb-4 shadow-lg"
                    >
                    
                    <p class="mt-6 text-xl">
                        ${isGrandSuccess ? 'é‡‘å±±éŠ€å±±å°±åœ¨çœ¼å‰ï¼Œä½ å¾—æ‰‹äº†ï¼' : 'æ²’æƒ³åˆ°ä½ ä¾†çš„å¤ªæ™šï¼Œæˆ–è€…ä»»å‹™å‡ºäº†é»å·®éŒ¯ï¼Œåªå‰©ä¸‹â‹¯â‹¯'}
                    </p>
                    <p class="mt-4 text-2xl font-bold p-3 bg-yellow-300 rounded-lg">
                        <strong>è«‹åˆ°ç°½åˆ°è™•å‡ºç¤ºé€™å€‹ç•«é¢é ˜å–ä½ çš„çå‹µï¼</strong>
                    </p>
                    ${renderLeaderboard(topTenRanks)}
                </div>
            `;
            controlsDiv.innerHTML = '';
        }

        function gameOver() {
            currentState = GAME_STATE.FAIL;
            clearScreen(); stopTimer(); window.scrollTo(0, 0);
            container.className = 'bg-red-900 text-white p-6 md:p-10 rounded-xl shadow-2xl max-w-lg w-full transition-all duration-500 border-4 border-red-700';
            contentDiv.innerHTML = `
                <div class="text-center">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-red-400 mt-4">è¡Œå‹•å¤±æ•—ï¼</h2>
                    <p class="mt-6 text-xl">æ›ç­çš„ä¿é¢å·²ç¶“åˆ°é”ï¼Œä½ è¢«æŠ“å€‹æ­£è‘—ã€‚é‡‘å¹£å¤¢ç¢ï¼</p>
                    <p class="mt-4">ä¸‹æ¬¡æº–å‚™æ›´å……åˆ†å†ä¾†å§ã€‚</p>
                </div>
            `;
            renderButton("é‡æ–°é–‹å§‹", goToInitialImageScreen); 
        }

        window.onload = initGame;
        
    </script>
</body>
</html>
